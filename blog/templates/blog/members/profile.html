{% extends 'blog/base.html' %}
{% load static %}
{% load blog_extras %}

{% block title %}{{ member.name }} - æœƒå“¡ä¸­å¿ƒ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/members/profile.css' %}">
{% endblock %}

{% block content %}
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Profile Header -->
<section class="profile-header">
    <div class="container">
        <div class="header-content">
            <div class="avatar-section">
                <div class="avatar-large" id="avatar-container">
                    {% if member.avatar %}
                    <img src="{{ member.avatar.url }}" alt="{{ member.name }}" class="avatar-img" id="profile-avatar">
                    {% else %}
                    <img src="{% static 'blog/images/å¤§é ­ç¶ .JPG' %}" alt="{{ member.name }}" class="avatar-img"
                        id="profile-avatar">
                    {% endif %}
                    <div class="avatar-overlay">
                        <span class="zoom-icon">ğŸ”</span>
                    </div>
                </div>
                <div class="level-badge {{ member.level|lower }}">
                    {% if member.level == 'Gold' %}ğŸ¥‡{% endif %}
                    {{ member.level }}
                </div>
            </div>

            <div class="profile-info" data-member-username="{{ member.username }}"
                data-member-url="{% url 'member_profile' username=member.username %}"
                data-member-name="{{ member.name }}"
                data-member-bio="{{ member.bio|default:'æŸ¥çœ‹æˆ‘çš„å€‹äººè³‡æ–™'|truncatewords:20 }}">
                <h1 class="profile-name">{{ member.name }}</h1>
                <p class="profile-username">@{{ member.username }}</p>
                <p class="profile-bio">{{ member.bio }}</p>

                <div class="profile-meta">
                    <span class="meta-item">
                        <span class="icon">ğŸ«</span>
                        {{ member.school }}
                    </span>
                    <span class="meta-item">
                        <span class="icon">ğŸ“š</span>
                        {{ member.grade }}
                    </span>
                    <span class="meta-item">
                        <span class="icon">ğŸ“</span>
                        {{ member.location }}
                    </span>
                    <span class="meta-item">
                        <span class="icon">ğŸ“…</span>
                        åŠ å…¥æ–¼ {{ member.joined_date }}
                    </span>
                </div>

                {% if member.website or member.github %}
                <div class="social-links">
                    {% if member.website %}
                    <a href="{{ member.website }}" target="_blank" rel="noopener noreferrer"
                        class="social-link website-link">
                        <span class="link-icon">ğŸŒ</span>
                        <span class="link-text">å€‹äººç¶²ç«™</span>
                    </a>
                    {% endif %}
                    {% if member.github %}
                    <a href="https://github.com/{{ member.github }}" target="_blank" rel="noopener noreferrer"
                        class="social-link github-link">
                        <span class="link-icon">ğŸ’»</span>
                        <span class="link-text">GitHub</span>
                    </a>
                    {% endif %}
                </div>
                {% endif %}

                <div class="profile-actions">
                    {% if is_own_profile %}
                    <a href="{% url 'member_edit' %}" class="btn btn-primary">ç·¨è¼¯å€‹äººè³‡æ–™</a>
                    {% else %}
                    {% if user.is_authenticated %}
                    <button class="btn {% if is_following %}btn-secondary{% else %}btn-primary{% endif %}"
                        id="follow-btn" data-username="{{ member.username }}"
                        data-following="{% if is_following %}true{% else %}false{% endif %}">
                        <span class="follow-icon">{% if is_following %}âœ“{% else %}+{% endif %}</span>
                        <span class="follow-text">{% if is_following %}å·²è¿½è¹¤{% else %}è¿½è¹¤{% endif %}</span>
                    </button>
                    <a href="{% url 'message_compose_to' username=member.username %}" class="btn btn-primary btn-message">
                        <span class="message-icon">âœ‰ï¸</span>
                        <span class="message-text">ç™¼é€è¨Šæ¯</span>
                    </a>
                    {% else %}
                    <a href="{% url 'user_login' %}?next={{ request.path }}" class="btn btn-primary">
                        <span class="follow-icon">+</span>
                        <span class="follow-text">è¿½è¹¤</span>
                    </a>
                    {% endif %}
                    {% endif %}
                    <button class="btn btn-outline" id="share-btn">åˆ†äº«</button>
                </div>

                <!-- åˆ†äº«é¸å–® -->
                <div id="share-menu" class="share-menu" style="display: none;">
                    <div class="share-menu-content">
                        <h3>åˆ†äº«å€‹äººè³‡æ–™</h3>
                        <div class="share-buttons">
                            <button class="share-button facebook" data-platform="facebook">
                                <span class="share-icon">f</span>
                                Facebook
                            </button>
                            <button class="share-button twitter" data-platform="twitter">
                                <span class="share-icon">ğ•</span>
                                Twitter
                            </button>
                            <button class="share-button line" data-platform="line">
                                <span class="share-icon">L</span>
                                LINE
                            </button>
                            <button class="share-button copy-link" data-platform="copy">
                                <span class="share-icon">ğŸ”—</span>
                                è¤‡è£½é€£çµ
                            </button>
                        </div>
                        <button class="share-close" id="share-close">âœ•</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="level-progress">
            <div class="progress-info">
                <span>ç­‰ç´šé€²åº¦</span>
                <span class="progress-text">{{ member.points }} / {{ member.next_level_points }} XP</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {% widthratio member.points member.next_level_points 100 %}%;">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Stats Grid -->
<section class="stats-section">
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.posts|default:"0" }}</div>
                    <div class="stat-label">ç™¼è¡¨æ–‡ç« </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.comments|default:"0" }}</div>
                    <div class="stat-label">è©•è«–æ•¸</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â¤ï¸</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.likes_received|default:"0" }}</div>
                    <div class="stat-label">ç²å¾—è®šæ•¸</div>
                </div>
            </div>
            <a href="{% url 'followers_list' username=member.username %}" class="stat-card stat-card-link">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.followers|default:"0" }}</div>
                    <div class="stat-label">è¿½è¹¤è€…</div>
                </div>
            </a>
            <a href="{% url 'following_list' username=member.username %}" class="stat-card stat-card-link">
                <div class="stat-icon">ğŸŒŸ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.following|default:"0" }}</div>
                    <div class="stat-label">è¿½è¹¤ä¸­</div>
                </div>
            </a>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="main-content">
    <div class="container">
        <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
                {% if is_own_profile %}
                <!-- Recent Activities (åªæœ‰æœ¬äººèƒ½çœ‹åˆ°) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æœ€è¿‘æ´»å‹•</h2>
                    </div>
                    <div class="card-body">
                        <div class="activity-list">
                            {% for activity in member.recent_activities %}
                            <div class="activity-item">
                                <div class="activity-icon">{{ activity.icon }}</div>
                                <div class="activity-content">
                                    <p class="activity-title">{% activity_title_with_link activity %}</p>
                                    <span class="activity-time">{{ activity.date }}</span>
                                </div>
                            </div>
                            {% empty %}
                            <p style="color: #6b7280; font-size: 0.875rem; text-align: center;">å°šç„¡æ´»å‹•è¨˜éŒ„</p>
                            {% endfor %}
                        </div>
                        {% if member.recent_activities %}
                        <a href="{% url 'member_activities' username=member.username %}" class="btn-text">æŸ¥çœ‹æ›´å¤šæ´»å‹• â†’</a>
                        {% endif %}
                    </div>
                </div>

                <!-- Learning Progress (åªæœ‰æœ¬äººèƒ½çœ‹åˆ°) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">å­¸ç¿’é€²åº¦</h2>
                    </div>
                    <div class="card-body">
                        {% for course in member.learning_progress %}
                        <div class="course-item">
                            <div class="course-info">
                                <span class="course-name">{{ course.course }}</span>
                                <span class="course-percent">{{ course.progress }}%</span>
                            </div>
                            <div class="course-bar">
                                <div class="course-fill"
                                    style="width: {{ course.progress }}%; background: {{ course.color }};"></div>
                            </div>
                        </div>
                        {% empty %}
                        <p style="color: #6b7280; font-size: 0.875rem; text-align: center;">å°šç„¡å­¸ç¿’é€²åº¦</p>
                        {% endfor %}
                        {% if member.learning_progress %}
                        <a href="{% url 'learning_progress' username=member.username %}" class="btn-text">æŸ¥çœ‹æ‰€æœ‰èª²ç¨‹ â†’</a>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- æœ€è¿‘ç™¼è¡¨çš„æ–‡ç« ï¼ˆæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°ï¼‰ -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æœ€è¿‘ç™¼è¡¨</h2>
                    </div>
                    <div class="card-body">
                        {% if member.recent_articles %}
                        <div class="articles-list">
                            {% for article in member.recent_articles %}
                            <div class="article-item">
                                <a href="{% url 'article_detail' id=article.id %}" class="article-link">
                                    <h3 class="article-title">{{ article.title }}</h3>
                                    <p class="article-excerpt">{{ article.content|truncatewords:20 }}</p>
                                    <div class="article-meta">
                                        <span class="article-date">{{ article.created_at|date:"Y-m-d" }}</span>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        <a href="{% url 'blog_home' %}?author={{ member.username }}" class="btn-text">æŸ¥çœ‹æ‰€æœ‰æ–‡ç«  â†’</a>
                        {% else %}
                        <p style="color: #6b7280; font-size: 0.875rem; text-align: center;">å°šæœªç™¼è¡¨ä»»ä½•æ–‡ç« </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Skills -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æŠ€èƒ½æ¨™ç±¤</h2>
                    </div>
                    <div class="card-body">
                        <div class="skills-grid">
                            {% for skill in member.skills %}
                            <span class="skill-tag">{{ skill }}</span>
                            {% empty %}
                            <p style="color: #6b7280; font-size: 0.875rem;">å°šæœªæ–°å¢æŠ€èƒ½æ¨™ç±¤</p>
                            {% endfor %}
                        </div>
                        {% if is_own_profile %}
                        <a href="{% url 'edit_skills' %}" class="btn-text">ç·¨è¼¯æŠ€èƒ½ â†’</a>
                        {% endif %}
                    </div>
                </div>

                <!-- Achievements -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æˆå°±å¾½ç« </h2>
                    </div>
                    <div class="card-body">
                        <div class="achievements-grid">
                            {% for achievement in member.achievements %}
                            <div class="achievement-item">
                                <div class="achievement-icon">{{ achievement.achievement.icon }}</div>
                                <div class="achievement-info">
                                    <p class="achievement-name">{{ achievement.achievement.name }}</p>
                                    <p class="achievement-desc">{{ achievement.achievement.description }}</p>
                                </div>
                            </div>
                            {% empty %}
                            <p style="color: #6b7280; font-size: 0.875rem;">å°šæœªè§£é–ä»»ä½•æˆå°±</p>
                            {% endfor %}
                        </div>
                        <a href="{% url 'member_achievements' username=member.username %}" class="btn-text">æŸ¥çœ‹æ‰€æœ‰æˆå°± â†’</a>
                    </div>
                </div>

                <!-- Quick Info -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">å€‹äººè³‡è¨Š</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-list">
                            {% if is_own_profile and member.email %}
                            <div class="info-item">
                                <span class="info-label">é›»å­ä¿¡ç®±</span>
                                <span class="info-value">{{ member.email }}</span>
                            </div>
                            {% endif %}
                            {% if is_own_profile and member.birthday %}
                            <div class="info-item">
                                <span class="info-label">ç”Ÿæ—¥</span>
                                <span class="info-value">{{ member.birthday }}</span>
                            </div>
                            {% endif %}
                            <div class="info-item">
                                <span class="info-label">ç©åˆ†</span>
                                <span class="info-value">{{ member.points }} XP</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœƒå“¡ç­‰ç´š</span>
                                <span class="info-value">{{ member.level }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Avatar Preview Modal -->
<div id="avatar-modal" class="avatar-modal" style="display: none;">
    <div class="avatar-modal-overlay"></div>
    <div class="avatar-modal-content">
        <button class="avatar-modal-close" id="close-avatar-modal">âœ•</button>
        {% if member.avatar %}
        <img src="{{ member.avatar.url }}" alt="{{ member.name }}" class="avatar-modal-img">
        {% else %}
        <img src="{% static 'blog/images/å¤§é ­ç¶ .JPG' %}" alt="{{ member.name }}" class="avatar-modal-img">
        {% endif %}
        <div class="avatar-modal-info">
            <h3>{{ member.name }}</h3>
            <p>@{{ member.username }}</p>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'blog/js/members/profile.js' %}"></script>
<script src="{% static 'blog/js/members/follow.js' %}"></script>
{% endblock %}
{% endblock %}