{% extends 'admin_dashboard/base.html' %}
{% load static %}

{% block title %}儀表板 - RuDjango 管理後台{% endblock %}

{% block page_header %}
<h2 class="my-6 text-2xl font-semibold text-gray-700 dark:text-gray-200">
    儀表板
</h2>
{% endblock %}

{% block content %}
<!-- Cards -->
<div class="grid gap-6 mb-8 md:grid-cols-2 xl:grid-cols-4">
    <!-- Card: Total Users -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-orange-500 bg-orange-100 rounded-full dark:text-orange-100 dark:bg-orange-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                總用戶數
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_users }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                今日新增: {{ new_users_today }} | 本週: {{ new_users_week }}
            </p>
        </div>
    </div>

    <!-- Card: Total Articles -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-green-500 bg-green-100 rounded-full dark:text-green-100 dark:bg-green-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                已發布文章
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_articles }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                草稿: {{ draft_articles }} | 本週新增: {{ articles_week }}
            </p>
        </div>
    </div>

    <!-- Card: Total Comments -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-blue-500 bg-blue-100 rounded-full dark:text-blue-100 dark:bg-blue-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                總留言數
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_comments }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                今日: {{ comments_today }}
            </p>
        </div>
    </div>

    <!-- Card: Total Likes -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-teal-500 bg-teal-100 rounded-full dark:text-teal-100 dark:bg-teal-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                總讚數
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_likes }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                收藏: {{ total_bookmarks }}
            </p>
        </div>
    </div>
</div>

<!-- Additional Stats Cards -->
<div class="grid gap-6 mb-8 md:grid-cols-2 xl:grid-cols-4">
    <!-- Card: Total Groups -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-purple-500 bg-purple-100 rounded-full dark:text-purple-100 dark:bg-purple-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                總群組數
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_groups }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                本週新增: {{ groups_week }} | 成員總數: {{ total_group_members }}
            </p>
        </div>
    </div>

    <!-- Card: Total Notifications -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-yellow-500 bg-yellow-100 rounded-full dark:text-yellow-100 dark:bg-yellow-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                總通知數
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_notifications }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                未讀: {{ unread_notifications }} | 本週: {{ notifications_week }}
            </p>
        </div>
    </div>

    <!-- Card: Total Tags -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-pink-500 bg-pink-100 rounded-full dark:text-pink-100 dark:bg-pink-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                總標籤數
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_tags }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                本週新增: {{ tags_week }}
            </p>
        </div>
    </div>

    <!-- Card: Messages -->
    <div class="flex items-center p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <div class="p-3 mr-4 text-indigo-500 bg-indigo-100 rounded-full dark:text-indigo-100 dark:bg-indigo-500">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M2 5a2 2 0 012-2h7a2 2 0 012 2v4a2 2 0 01-2 2H9l-3 3v-3H4a2 2 0 01-2-2V5z"></path>
                <path d="M15 7v2a4 4 0 01-4 4H9.828l-1.766 1.767c.28.149.599.233.938.233h2l3 3v-3h2a2 2 0 002-2V9a2 2 0 00-2-2h-1z"></path>
            </svg>
        </div>
        <div>
            <p class="mb-2 text-sm font-medium text-gray-600 dark:text-gray-400">
                即時訊息
            </p>
            <p class="text-lg font-semibold text-gray-700 dark:text-gray-200">
                {{ total_messages }}
            </p>
            <p class="text-xs text-gray-600 dark:text-gray-400">
                今日: {{ messages_today }}
            </p>
        </div>
    </div>
</div>

<!-- Tables -->
<div class="grid gap-6 mb-8 md:grid-cols-2">
    <!-- Popular Articles -->
    <div class="min-w-0 p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <h4 class="mb-4 font-semibold text-gray-800 dark:text-gray-300">
            熱門文章 Top 10
        </h4>
        <div class="w-full overflow-hidden rounded-lg shadow-xs">
            <div class="w-full overflow-x-auto">
                <table class="w-full whitespace-no-wrap">
                    <thead>
                        <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b dark:border-gray-700 bg-gray-50 dark:text-gray-400 dark:bg-gray-800">
                            <th class="px-4 py-3">文章標題</th>
                            <th class="px-4 py-3">作者</th>
                            <th class="px-4 py-3">讚數</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y dark:divide-gray-700 dark:bg-gray-800">
                        {% for article in popular_articles %}
                        <tr class="text-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                            <td class="px-4 py-3">
                                <div class="flex items-center text-sm">
                                    <div>
                                        <a href="{% url 'article_detail' article.id %}"
                                           target="_blank"
                                           class="font-semibold text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:underline">
                                            {{ article.title|truncatechars:40 }}
                                        </a>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                <a href="{% url 'member_profile' article.author.username %}"
                                   target="_blank"
                                   class="text-purple-600 hover:text-purple-800 dark:text-purple-400 dark:hover:text-purple-300 hover:underline">
                                    {{ article.author.username }}
                                </a>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                {{ article.like_count }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="3" class="px-4 py-3 text-sm text-center text-gray-500">
                                暫無數據
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Popular Tags -->
    <div class="min-w-0 p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <h4 class="mb-4 font-semibold text-gray-800 dark:text-gray-300">
            熱門標籤 Top 10
        </h4>
        <div class="w-full overflow-hidden rounded-lg shadow-xs">
            <div class="w-full overflow-x-auto">
                <table class="w-full whitespace-no-wrap">
                    <thead>
                        <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b dark:border-gray-700 bg-gray-50 dark:text-gray-400 dark:bg-gray-800">
                            <th class="px-4 py-3">標籤名稱</th>
                            <th class="px-4 py-3">文章數</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y dark:divide-gray-700 dark:bg-gray-800">
                        {% for tag in popular_tags %}
                        <tr class="text-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                            <td class="px-4 py-3">
                                <div class="flex items-center text-sm">
                                    <a href="{% url 'tag_articles' tag.slug %}"
                                       target="_blank"
                                       class="px-2 py-1 font-semibold leading-tight text-purple-700 bg-purple-100 rounded-full dark:bg-purple-700 dark:text-purple-100 hover:bg-purple-200 dark:hover:bg-purple-600 transition-colors duration-150">
                                        {{ tag.name }}
                                    </a>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm">
                                {{ tag.total_articles }}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="2" class="px-4 py-3 text-sm text-center text-gray-500">
                                暫無數據
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Active Users -->
<div class="min-w-0 p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
    <h4 class="mb-4 font-semibold text-gray-800 dark:text-gray-300">
        活躍用戶 Top 10
    </h4>
    <div class="w-full overflow-hidden rounded-lg shadow-xs">
        <div class="w-full overflow-x-auto">
            <table class="w-full whitespace-no-wrap">
                <thead>
                    <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b dark:border-gray-700 bg-gray-50 dark:text-gray-400 dark:bg-gray-800">
                        <th class="px-4 py-3">用戶</th>
                        <th class="px-4 py-3">發文數</th>
                        <th class="px-4 py-3">註冊時間</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y dark:divide-gray-700 dark:bg-gray-800">
                    {% for user in active_users %}
                    <tr class="text-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                        <td class="px-4 py-3">
                            <a href="{% url 'member_profile' user.username %}"
                               target="_blank"
                               class="flex items-center text-sm group">
                                <div class="relative w-8 h-8 mr-3 rounded-full">
                                    <img class="object-cover w-full h-full rounded-full"
                                         src="{% if user.profile.avatar %}{{ user.profile.avatar.url }}{% else %}https://ui-avatars.com/api/?name={{ user.username }}&background=random{% endif %}"
                                         alt="{{ user.username }}" loading="lazy" />
                                    <div class="absolute inset-0 rounded-full shadow-inner" aria-hidden="true"></div>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-700 dark:text-gray-300 group-hover:text-blue-600 dark:group-hover:text-blue-400">{{ user.username }}</p>
                                </div>
                            </a>
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {{ user.article_count }}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {{ user.date_joined|date:"Y-m-d" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="px-4 py-3 text-sm text-center text-gray-500">
                            暫無數據
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Popular Groups -->
<div class="min-w-0 p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800 mt-8">
    <h4 class="mb-4 font-semibold text-gray-800 dark:text-gray-300">
        熱門群組 Top 5
    </h4>
    <div class="w-full overflow-hidden rounded-lg shadow-xs">
        <div class="w-full overflow-x-auto">
            <table class="w-full whitespace-no-wrap">
                <thead>
                    <tr class="text-xs font-semibold tracking-wide text-left text-gray-500 uppercase border-b dark:border-gray-700 bg-gray-50 dark:text-gray-400 dark:bg-gray-800">
                        <th class="px-4 py-3">群組名稱</th>
                        <th class="px-4 py-3">類型</th>
                        <th class="px-4 py-3">成員數</th>
                        <th class="px-4 py-3">文章數</th>
                        <th class="px-4 py-3">建立時間</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y dark:divide-gray-700 dark:bg-gray-800">
                    {% for group in popular_groups %}
                    <tr class="text-gray-700 dark:text-gray-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-150">
                        <td class="px-4 py-3">
                            <div class="flex items-center text-sm">
                                <div class="relative w-10 h-10 mr-3 rounded">
                                    {% if group.cover_image %}
                                    <img class="object-cover w-full h-full rounded"
                                         src="{{ group.cover_image.url }}"
                                         alt="{{ group.name }}" loading="lazy" />
                                    {% else %}
                                    <div class="w-full h-full rounded bg-purple-500 flex items-center justify-center text-white font-bold">
                                        {{ group.name|first|upper }}
                                    </div>
                                    {% endif %}
                                    <div class="absolute inset-0 rounded shadow-inner" aria-hidden="true"></div>
                                </div>
                                <div>
                                    <a href="{% url 'admin_dashboard:group_detail' group.id %}"
                                       class="font-semibold text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 hover:underline">
                                        {{ group.name }}
                                    </a>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            {% if group.group_type == 'public' %}
                            <span class="px-2 py-1 text-xs font-semibold leading-tight text-green-700 bg-green-100 rounded-full dark:bg-green-700 dark:text-green-100">
                                {{ group.get_group_type_display }}
                            </span>
                            {% elif group.group_type == 'private' %}
                            <span class="px-2 py-1 text-xs font-semibold leading-tight text-orange-700 bg-orange-100 rounded-full dark:bg-orange-700 dark:text-orange-100">
                                {{ group.get_group_type_display }}
                            </span>
                            {% else %}
                            <span class="px-2 py-1 text-xs font-semibold leading-tight text-purple-700 bg-purple-100 rounded-full dark:bg-purple-700 dark:text-purple-100">
                                {{ group.get_group_type_display }}
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {{ group.member_count }}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {{ group.post_count }}
                        </td>
                        <td class="px-4 py-3 text-sm">
                            {{ group.created_at|date:"Y-m-d" }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-4 py-3 text-sm text-center text-gray-500">
                            暫無數據
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Notification Type Distribution -->
<div class="grid gap-6 mb-8 md:grid-cols-2 mt-8">
    <div class="min-w-0 p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <h4 class="mb-4 font-semibold text-gray-800 dark:text-gray-300">
            通知類型分佈
        </h4>
        <div class="space-y-3">
            {% for type_name, count in notification_by_type.items %}
            <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">{{ type_name }}</span>
                <div class="flex items-center">
                    <div class="mr-3 w-32 bg-gray-200 rounded-full h-2 dark:bg-gray-600">
                        {% widthratio count total_notifications 100 as percentage %}
                        <div class="bg-purple-600 h-2 rounded-full" style="width: {{ percentage|default:0 }}%"></div>
                    </div>
                    <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">{{ count }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="min-w-0 p-4 bg-white rounded-lg shadow-xs dark:bg-gray-800">
        <h4 class="mb-4 font-semibold text-gray-800 dark:text-gray-300">
            最新通知
        </h4>
        <div class="space-y-3">
            {% for notification in recent_notifications %}
            <div class="flex items-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg {% if not notification.is_read %}border-l-4 border-blue-500{% endif %}">
                <span class="text-2xl mr-3">{{ notification.get_icon }}</span>
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-700 dark:text-gray-300">
                        {{ notification.message|truncatechars:50 }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                        {{ notification.created_at|date:"Y-m-d H:i" }}
                    </p>
                </div>
                {% if not notification.is_read %}
                <span class="inline-flex items-center justify-center min-w-[2rem] px-3 py-1.5 text-xs font-semibold text-blue-700 bg-blue-100 rounded-full dark:bg-blue-700 dark:text-blue-100">
                    新
                </span>
                {% endif %}
            </div>
            {% empty %}
            <p class="text-sm text-center text-gray-500 dark:text-gray-400 py-4">
                暫無通知
            </p>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
