{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ message.subject }} - RuDjango{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/messages.css' %}">
{% endblock %}

{% block content %}
<div class="messages-container">
    <!-- è¿”å›æŒ‰éˆ• -->
    <div class="message-detail-header">
        {% if is_recipient %}
            <a href="{% url 'inbox' %}" class="btn-back">â† è¿”å›æ”¶ä»¶åŒ£</a>
        {% else %}
            <a href="{% url 'outbox' %}" class="btn-back">â† è¿”å›å¯„ä»¶åŒ£</a>
        {% endif %}
    </div>

    <!-- è¨Šæ¯è©³æƒ… -->
    <div class="message-detail-card">
        <div class="message-detail-header-info">
            <h1 class="message-subject-detail">{{ message.subject }}</h1>
            <div class="message-meta">
                <div class="message-participants">
                    <div class="participant">
                        <span class="label">å¯„ä»¶è€…ï¼š</span>
                        <a href="{% url 'member_profile' username=message.sender.username %}" class="participant-name">
                            {{ message.sender.first_name|default:message.sender.username }}
                        </a>
                    </div>
                    <div class="participant">
                        <span class="label">æ”¶ä»¶è€…ï¼š</span>
                        <a href="{% url 'member_profile' username=message.recipient.username %}" class="participant-name">
                            {{ message.recipient.first_name|default:message.recipient.username }}
                        </a>
                    </div>
                </div>
                <div class="message-time-detail">
                    ğŸ“… {{ message.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}
                    {% if message.is_read and message.read_at %}
                        <br><span class="read-time">âœ“ å·²æ–¼ {{ message.read_at|date:"Y-m-d H:i" }} é–±è®€</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="message-content-detail">
            {% if message.is_recalled %}
                <div class="recalled-message-notice">
                    {% if is_sender %}
                    <p>âš ï¸ æ­¤è¨Šæ¯å·²è¢«æ‚¨æ”¶å›</p>
                    {% else %}
                    <p>âš ï¸ æ­¤è¨Šæ¯å·²è¢«å¯„ä»¶è€…æ”¶å›</p>
                    {% endif %}
                    <p class="recalled-time">æ”¶å›æ™‚é–“ï¼š{{ message.recalled_at|date:"Y-m-d H:i" }}</p>
                </div>
            {% else %}
                {{ message.content|linebreaksbr }}
            {% endif %}
        </div>

        <div class="message-detail-actions">
            {% if can_recall %}
            <a href="{% url 'message_recall' message.id %}" class="btn-recall" onclick="return confirm('ç¢ºå®šè¦æ”¶å›æ­¤è¨Šæ¯å—ï¼Ÿæ”¶å›å¾Œå°æ–¹å°‡ç„¡æ³•æŸ¥çœ‹æ­¤è¨Šæ¯å…§å®¹ã€‚')">ğŸ”™ æ”¶å›è¨Šæ¯</a>
            {% endif %}
            <a href="{% url 'message_delete' message.id %}" class="btn-delete" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è¨Šæ¯å—ï¼Ÿ')">ğŸ—‘ï¸ åˆªé™¤</a>
        </div>
    </div>

    <!-- å›è¦†åˆ—è¡¨ -->
    {% if replies %}
    <div class="replies-section">
        <h2 class="replies-title">ğŸ’¬ å›è¦†è¨˜éŒ„ ({{ replies.count }})</h2>
        {% for reply in replies %}
        <div class="reply-item {% if reply.sender == request.user %}own-reply{% endif %}">
            <div class="reply-header">
                <a href="{% url 'member_profile' username=reply.sender.username %}" class="reply-sender">
                    {{ reply.sender.first_name|default:reply.sender.username }}
                </a>
                <span class="reply-time">{{ reply.created_at|date:"Y-m-d H:i" }}</span>
            </div>
            <div class="reply-content">
                {{ reply.content|linebreaksbr }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- å›è¦†è¡¨å–® -->
    <div class="reply-form-section">
        <h2 class="reply-form-title">ğŸ’¬ å›è¦†è¨Šæ¯</h2>
        <form method="post" class="reply-form">
            {% csrf_token %}
            <div class="form-group">
                {{ reply_form.content }}
                {% if reply_form.content.errors %}
                    <div class="error-message">
                        {{ reply_form.content.errors }}
                    </div>
                {% endif %}
            </div>
            <div class="form-actions">
                <button type="submit" class="btn-submit">ğŸ“¤ ç™¼é€å›è¦†</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
