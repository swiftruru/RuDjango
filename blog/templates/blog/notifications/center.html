{% extends 'blog/base.html' %}
{% load static %}

{% block title %}é€šçŸ¥ä¸­å¿ƒ - RuDjango{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/notifications/center.css' %}">
{% endblock %}

{% block content %}
<section class="notifications-header">
    <div class="container">
        <h1>ğŸ”” é€šçŸ¥ä¸­å¿ƒ</h1>
        <p>ç®¡ç†æ‚¨çš„æ‰€æœ‰é€šçŸ¥</p>
    </div>
</section>

<section class="notifications-section">
    <div class="container">
        <!-- ç¯©é¸å™¨ -->
        <div class="notifications-filters">
            <div class="filter-tabs">
                <a href="{% url 'notifications_center' %}?filter=all&type={{ notification_type }}"
                   class="filter-tab {% if filter_type == 'all' %}active{% endif %}">
                    å…¨éƒ¨ ({{ unread_count }})
                </a>
                <a href="{% url 'notifications_center' %}?filter=unread&type={{ notification_type }}"
                   class="filter-tab {% if filter_type == 'unread' %}active{% endif %}">
                    æœªè®€
                </a>
                <a href="{% url 'notifications_center' %}?filter=read&type={{ notification_type }}"
                   class="filter-tab {% if filter_type == 'read' %}active{% endif %}">
                    å·²è®€
                </a>
            </div>

            <div class="filter-types">
                <select id="notification-type-filter" class="type-select">
                    <option value="all" {% if notification_type == 'all' %}selected{% endif %}>æ‰€æœ‰é¡å‹</option>
                    <option value="comment" {% if notification_type == 'comment' %}selected{% endif %}>ğŸ’¬ ç•™è¨€</option>
                    <option value="like" {% if notification_type == 'like' %}selected{% endif %}>â¤ï¸ æŒ‰è®š</option>
                    <option value="follower" {% if notification_type == 'follower' %}selected{% endif %}>ğŸ‘¥ è¿½è¹¤</option>
                    <option value="message" {% if notification_type == 'message' %}selected{% endif %}>âœ‰ï¸ ç§è¨Š</option>
                    <option value="share" {% if notification_type == 'share' %}selected{% endif %}>ğŸ”— åˆ†äº«</option>
                </select>
            </div>

            <div class="filter-actions">
                <form method="post" action="{% url 'notification_mark_all_read' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-mark-all-read" {% if unread_count == 0 %}disabled{% endif %}>
                        âœ“ å…¨éƒ¨æ¨™ç‚ºå·²è®€
                    </button>
                </form>
                <form method="post" action="{% url 'notification_delete_all_read' %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn-delete-read" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å·²è®€é€šçŸ¥å—ï¼Ÿ')">
                        ğŸ—‘ï¸ åˆªé™¤å·²è®€
                    </button>
                </form>
                <a href="{% url 'notification_preferences' %}" class="btn-settings">
                    âš™ï¸ é€šçŸ¥è¨­å®š
                </a>
            </div>
        </div>

        <!-- é€šçŸ¥åˆ—è¡¨ -->
        <div class="notifications-list">
            {% if notifications %}
                {% for notification in notifications %}
                <div class="notification-item {% if not notification.is_read %}unread{% endif %}"
                     data-notification-id="{{ notification.id }}"
                     {% if notification.link %}
                     onclick="handleNotificationClick(event, {{ notification.id }}, '{{ notification.link }}')"
                     style="cursor: pointer;"
                     {% endif %}>
                    <div class="notification-icon">
                        {{ notification.get_icon }}
                    </div>
                    <div class="notification-content">
                        <div class="notification-message">
                            {{ notification.message }}
                        </div>
                        <div class="notification-meta">
                            <span class="notification-time">{{ notification.get_time_since }}</span>
                            {% if notification.sender %}
                            <span class="notification-sender">ä¾†è‡ª {{ notification.sender.username }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="notification-actions">
                        {% if not notification.is_read %}
                        <form method="post" action="{% url 'notification_mark_read' notification.id %}"
                              style="display: inline;" class="mark-read-form">
                            {% csrf_token %}
                            <button type="submit" class="btn-mark-read" title="æ¨™ç‚ºå·²è®€"
                                    onclick="event.stopPropagation();">
                                âœ“
                            </button>
                        </form>
                        {% endif %}
                        <form method="post" action="{% url 'notification_delete' notification.id %}"
                              style="display: inline;" class="delete-form">
                            {% csrf_token %}
                            <button type="submit" class="btn-delete"
                                    onclick="event.stopPropagation(); return confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é€šçŸ¥å—ï¼Ÿ')" title="åˆªé™¤">
                                âœ•
                            </button>
                        </form>
                    </div>
                </div>
                {% endfor %}

                <!-- åˆ†é  -->
                {% if page_obj.has_other_pages %}
                <div class="pagination">
                    {% if page_obj.has_previous %}
                    <a href="?page=1&filter={{ filter_type }}&type={{ notification_type }}"
                       class="page-link">Â« é¦–é </a>
                    <a href="?page={{ page_obj.previous_page_number }}&filter={{ filter_type }}&type={{ notification_type }}"
                       class="page-link">â€¹ ä¸Šä¸€é </a>
                    {% endif %}

                    <span class="page-current">ç¬¬ {{ page_obj.number }} é ï¼Œå…± {{ page_obj.paginator.num_pages }} é </span>

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}&filter={{ filter_type }}&type={{ notification_type }}"
                       class="page-link">ä¸‹ä¸€é  â€º</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}&filter={{ filter_type }}&type={{ notification_type }}"
                       class="page-link">æœ«é  Â»</a>
                    {% endif %}
                </div>
                {% endif %}

            {% else %}
                <div class="no-notifications">
                    <div class="no-notifications-icon">ğŸ””</div>
                    <p>æ²’æœ‰é€šçŸ¥</p>
                    {% if filter_type != 'all' %}
                    <a href="{% url 'notifications_center' %}" class="btn-view-all">æŸ¥çœ‹æ‰€æœ‰é€šçŸ¥</a>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</section>

{% endblock %}

{% block extra_js %}
<script src="{% static 'blog/js/notifications/center.js' %}"></script>
<script>
    // é¡å‹ç¯©é¸åˆ‡æ›
    document.getElementById('notification-type-filter').addEventListener('change', function() {
        const type = this.value;
        const filter = '{{ filter_type }}';
        window.location.href = `{% url 'notifications_center' %}?filter=${filter}&type=${type}`;
    });

    // è™•ç†é€šçŸ¥å€å¡Šé»æ“Š
    function handleNotificationClick(event, notificationId, link) {
        // å¦‚æœé»æ“Šçš„æ˜¯æŒ‰éˆ•ï¼Œä¸åŸ·è¡Œè·³è½‰
        if (event.target.closest('.notification-actions button')) {
            return;
        }

        // æ¨™è¨˜ç‚ºå·²è®€
        markAsRead(notificationId);

        // è·³è½‰åˆ°é€šçŸ¥é€£çµ
        window.location.href = link;
    }

    // æ¨™è¨˜ç‚ºå·²è®€ (AJAX)
    function markAsRead(notificationId) {
        fetch(`/blog/notifications/${notificationId}/read/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        }).then(response => response.json())
          .then(data => {
              if (data.success) {
                  // æ›´æ–° UI
                  const item = document.querySelector(`[data-notification-id="${notificationId}"]`);
                  if (item) {
                      item.classList.remove('unread');
                  }
              }
          });
    }
</script>
{% endblock %}
