{% extends 'blog/base.html' %}
{% load static %}
{% load blog_extras %}

{% block title %}æˆ‘çš„æ”¶è— - RuDjango{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/articles/list.css' %}">
<style>
    .bookmark-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .bookmark-header h1 {
        margin: 0 0 0.5rem 0;
        font-size: 2rem;
    }

    .bookmark-stats {
        display: flex;
        gap: 1.5rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .stat-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .bookmark-list {
        display: grid;
        gap: 1.5rem;
        margin-bottom: 3rem;
        padding: 0 0.5rem;
    }

    .bookmark-item {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .bookmark-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .bookmark-article-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .bookmark-article-title a {
        color: #2d3748;
        text-decoration: none;
    }

    .bookmark-article-title a:hover {
        color: #667eea;
    }

    .bookmark-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.9rem;
        color: #718096;
        margin-bottom: 1rem;
        flex-wrap: wrap;
    }

    .bookmark-note {
        background: #f7fafc;
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 4px;
    }

    .bookmark-note-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #2d3748;
    }

    .bookmark-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
    }

    .btn-remove {
        padding: 0.5rem 1rem;
        background: #f56565;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: background 0.2s;
    }

    .btn-remove:hover {
        background: #e53e3e;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }

    .empty-state h2 {
        color: #2d3748;
        margin-bottom: 1rem;
    }

    .empty-state p {
        color: #718096;
        margin-bottom: 1.5rem;
    }

    .btn-primary {
        display: inline-block;
        padding: 0.75rem 1.5rem;
        background: #667eea;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        transition: background 0.2s;
    }

    .btn-primary:hover {
        background: #5a67d8;
    }

    /* åˆ†é æ¨£å¼ */
    .pagination {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-top: 2rem;
        flex-wrap: wrap;
    }

    .pagination a,
    .pagination .current {
        padding: 0.5rem 1rem;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
        text-decoration: none;
        color: #4a5568;
    }

    .pagination a:hover {
        background: #f7fafc;
    }

    .pagination .current {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="padding-bottom: 3rem;">
    <!-- é é¢æ¨™é¡Œ -->
    <div class="bookmark-header">
        <h1>ğŸ“‘ æˆ‘çš„æ”¶è—</h1>
        <div class="bookmark-stats">
            <div class="stat-item">
                <span>ğŸ“š ç¸½æ”¶è—</span>
                <strong>{{ total_bookmarks }}</strong>
            </div>
        </div>
    </div>

    <!-- æ”¶è—åˆ—è¡¨ -->
    {% if bookmarks %}
    <div class="bookmark-list">
        {% for bookmark in bookmarks %}
        <div class="bookmark-item">
            <h2 class="bookmark-article-title">
                <a href="{% url 'article_detail' bookmark.article.id %}">{{ bookmark.article.title }}</a>
            </h2>

            <div class="bookmark-meta">
                {% if bookmark.article.author %}
                <span>âœï¸ {{ bookmark.article.author|author_display }}</span>
                {% endif %}
                <span>ğŸ“… æ”¶è—æ–¼ {{ bookmark.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
                {% if bookmark.article.reading_time > 0 %}
                <span>ğŸ“– é–±è®€æ™‚é–“: {{ bookmark.article.reading_time }} åˆ†é˜</span>
                {% endif %}
            </div>

            <!-- æ–‡ç« æ¨™ç±¤ -->
            {% if bookmark.article.tags.all %}
            <div class="article-tags" style="margin-top: 0.5rem;">
                {% for tag in bookmark.article.tags.all %}
                <a href="{% url 'tag_articles' tag.slug %}" class="tag" style="display: inline-block; padding: 0.25rem 0.75rem; background: #e2e8f0; color: #4a5568; text-decoration: none; border-radius: 15px; font-size: 0.85rem; margin-right: 0.5rem;">
                    ğŸ·ï¸ {{ tag.name }}
                </a>
                {% endfor %}
            </div>
            {% endif %}

            <!-- ç­†è¨˜ -->
            {% if bookmark.note %}
            <div class="bookmark-note">
                <div class="bookmark-note-title">ğŸ“ æˆ‘çš„ç­†è¨˜</div>
                <div>{{ bookmark.note|linebreaksbr }}</div>
            </div>
            {% endif %}

            <!-- æ“ä½œæŒ‰éˆ• -->
            <div class="bookmark-actions">
                <button class="btn-remove"
                        data-article-id="{{ bookmark.article.id }}"
                        data-bookmark-id="{{ bookmark.id }}"
                        onclick="removeBookmark(this)">
                    å–æ¶ˆæ”¶è—
                </button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- åˆ†é  -->
    {% if bookmarks.has_other_pages %}
    <div class="pagination">
        {% if bookmarks.has_previous %}
        <a href="?page=1">ç¬¬ä¸€é </a>
        <a href="?page={{ bookmarks.previous_page_number }}">ä¸Šä¸€é </a>
        {% endif %}

        <span class="current">ç¬¬ {{ bookmarks.number }} é ï¼Œå…± {{ bookmarks.paginator.num_pages }} é </span>

        {% if bookmarks.has_next %}
        <a href="?page={{ bookmarks.next_page_number }}">ä¸‹ä¸€é </a>
        <a href="?page={{ bookmarks.paginator.num_pages }}">æœ€å¾Œä¸€é </a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <!-- ç©ºç‹€æ…‹ -->
    <div class="empty-state">
        <div class="empty-state-icon">ğŸ“‘</div>
        <h2>é‚„æ²’æœ‰æ”¶è—ä»»ä½•æ–‡ç« </h2>
        <p>é–‹å§‹æ¢ç´¢ç²¾å½©çš„æ–‡ç« ï¼Œä¸¦å°‡æ‚¨å–œæ­¡çš„å…§å®¹åŠ å…¥æ”¶è—ï¼</p>
        <a href="{% url 'blog_home' %}" class="btn-primary">ç€è¦½æ–‡ç« </a>
    </div>
    {% endif %}
</div>

<script>
// å¾ cookie ä¸­å–å¾— CSRF token
function getCsrfToken() {
    const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
    return cookieValue;
}

// å–æ¶ˆæ”¶è—åŠŸèƒ½
function removeBookmark(button) {
    if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ”¶è—é€™ç¯‡æ–‡ç« å—ï¼Ÿ')) {
        return;
    }

    const articleId = button.dataset.articleId;
    const csrfToken = getCsrfToken();

    if (!csrfToken) {
        alert('ç„¡æ³•å–å¾—å®‰å…¨ä»¤ç‰Œï¼Œè«‹é‡æ–°æ•´ç†é é¢');
        return;
    }

    button.disabled = true;
    button.textContent = 'è™•ç†ä¸­...';

    fetch(`/blog/article/${articleId}/bookmark/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ç§»é™¤é€™å€‹æ”¶è—é …ç›®
            button.closest('.bookmark-item').style.opacity = '0';
            setTimeout(() => {
                button.closest('.bookmark-item').remove();

                // å¦‚æœæ²’æœ‰æ›´å¤šæ”¶è—ï¼Œåˆ·æ–°é é¢é¡¯ç¤ºç©ºç‹€æ…‹
                if (document.querySelectorAll('.bookmark-item').length === 0) {
                    location.reload();
                }
            }, 300);
        } else {
            alert(data.error || 'æ“ä½œå¤±æ•—');
            button.disabled = false;
            button.textContent = 'å–æ¶ˆæ”¶è—';
        }
    })
    .catch(error => {
        console.error('å–æ¶ˆæ”¶è—å¤±æ•—:', error);
        alert('ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        button.disabled = false;
        button.textContent = 'å–æ¶ˆæ”¶è—';
    });
}
</script>
{% endblock %}
