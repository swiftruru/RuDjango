{% extends 'blog/base.html' %}
{% load static %}

{% block title %}æ›´æ”¹å¯†ç¢¼{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/members/edit_profile.css' %}">
<style>
    .password-match-indicator {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        font-size: 0.875rem;
        display: none;
    }

    .password-match-indicator.show {
        display: block;
    }

    .password-match-indicator.match {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .password-match-indicator.no-match {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .password-strength {
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }

    .strength-bar {
        height: 4px;
        background-color: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 0.25rem;
    }

    .strength-bar-fill {
        height: 100%;
        transition: width 0.3s ease, background-color 0.3s ease;
        width: 0%;
    }

    .strength-weak .strength-bar-fill {
        background-color: #ef4444;
        width: 33%;
    }

    .strength-medium .strength-bar-fill {
        background-color: #f59e0b;
        width: 66%;
    }

    .strength-strong .strength-bar-fill {
        background-color: #10b981;
        width: 100%;
    }

    /* å¯†ç¢¼é¡¯ç¤º/éš±è—æŒ‰éˆ• */
    .password-input-wrapper {
        position: relative;
    }

    .password-toggle {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #6b7280;
        font-size: 1.25rem;
        line-height: 1;
        transition: color 0.2s;
        user-select: none;
    }

    .password-toggle:hover {
        color: #374151;
    }

    .password-toggle:focus {
        outline: none;
    }

    .password-input-wrapper input {
        padding-right: 2.75rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <div class="edit-card">
        <h1>æ›´æ”¹å¯†ç¢¼</h1>
        <p>ç‚ºäº†ä¿è­·æ‚¨çš„å¸³è™Ÿå®‰å…¨ï¼Œè«‹å®šæœŸæ›´æ–°å¯†ç¢¼</p>

        <form method="post" id="password-change-form">
            {% csrf_token %}

            <div class="form-section">
                <h2>å¯†ç¢¼è³‡è¨Š</h2>

                <div class="form-group">
                    <label for="id_old_password">èˆŠå¯†ç¢¼</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="old_password" class="form-control" id="id_old_password" required>
                        <button type="button" class="password-toggle" data-target="id_old_password" aria-label="é¡¯ç¤ºå¯†ç¢¼">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    {% if form.old_password.errors %}
                        <ul class="errorlist">
                            {% for error in form.old_password.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <p class="form-help">è«‹è¼¸å…¥æ‚¨ç›®å‰ä½¿ç”¨çš„å¯†ç¢¼</p>
                </div>

                <div class="form-group">
                    <label for="id_new_password1">æ–°å¯†ç¢¼</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="new_password1" class="form-control" id="id_new_password1" required>
                        <button type="button" class="password-toggle" data-target="id_new_password1" aria-label="é¡¯ç¤ºå¯†ç¢¼">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    {% if form.new_password1.errors %}
                        <ul class="errorlist">
                            {% for error in form.new_password1.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-bar-fill"></div>
                        </div>
                        <p class="form-help">å¯†ç¢¼è‡³å°‘éœ€è¦ 8 å€‹å­—å…ƒï¼Œä¸”ä¸èƒ½æ˜¯å¸¸è¦‹å¯†ç¢¼</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="id_new_password2">æ–°å¯†ç¢¼ç¢ºèª</label>
                    <div class="password-input-wrapper">
                        <input type="password" name="new_password2" class="form-control" id="id_new_password2" required>
                        <button type="button" class="password-toggle" data-target="id_new_password2" aria-label="é¡¯ç¤ºå¯†ç¢¼">
                            ğŸ‘ï¸
                        </button>
                    </div>
                    {% if form.new_password2.errors %}
                        <ul class="errorlist">
                            {% for error in form.new_password2.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="password-match-indicator" id="password-match-indicator">
                        <span id="match-message"></span>
                    </div>
                    <p class="form-help">è«‹å†æ¬¡è¼¸å…¥æ–°å¯†ç¢¼ä»¥ç¢ºèª</p>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn">æ›´æ–°å¯†ç¢¼</button>
                <a href="{% url 'member_edit' %}" class="btn btn-secondary">å–æ¶ˆ</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword1 = document.getElementById('id_new_password1');
    const newPassword2 = document.getElementById('id_new_password2');
    const matchIndicator = document.getElementById('password-match-indicator');
    const matchMessage = document.getElementById('match-message');
    const submitBtn = document.getElementById('submit-btn');
    const strengthBar = document.querySelector('.password-strength');
    const strengthBarFill = document.querySelector('.strength-bar-fill');

    // å¯†ç¢¼é¡¯ç¤º/éš±è—åˆ‡æ›
    const toggleButtons = document.querySelectorAll('.password-toggle');
    toggleButtons.forEach(button => {
        button.addEventListener('click', function() {
            const targetId = this.getAttribute('data-target');
            const input = document.getElementById(targetId);

            if (input.type === 'password') {
                input.type = 'text';
                this.textContent = 'ğŸ™ˆ'; // é–‰çœ¼åœ–æ¨™
                this.setAttribute('aria-label', 'éš±è—å¯†ç¢¼');
            } else {
                input.type = 'password';
                this.textContent = 'ğŸ‘ï¸'; // çœçœ¼åœ–æ¨™
                this.setAttribute('aria-label', 'é¡¯ç¤ºå¯†ç¢¼');
            }
        });
    });

    // å¯†ç¢¼å¼·åº¦æª¢æ¸¬
    function checkPasswordStrength(password) {
        if (password.length === 0) {
            strengthBar.className = 'password-strength';
            return;
        }

        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        if (strength <= 2) {
            strengthBar.className = 'password-strength strength-weak';
        } else if (strength <= 4) {
            strengthBar.className = 'password-strength strength-medium';
        } else {
            strengthBar.className = 'password-strength strength-strong';
        }
    }

    // æª¢æŸ¥å¯†ç¢¼æ˜¯å¦åŒ¹é…
    function checkPasswordMatch() {
        const password1 = newPassword1.value;
        const password2 = newPassword2.value;

        // å¦‚æœç¢ºèªå¯†ç¢¼æ¡†ç‚ºç©ºï¼Œä¸é¡¯ç¤ºä»»ä½•æç¤º
        if (password2.length === 0) {
            matchIndicator.classList.remove('show');
            return;
        }

        // é¡¯ç¤ºåŒ¹é…æŒ‡ç¤ºå™¨
        matchIndicator.classList.add('show');

        if (password1 === password2) {
            matchIndicator.classList.remove('no-match');
            matchIndicator.classList.add('match');
            matchMessage.textContent = 'âœ“ å¯†ç¢¼ç›¸ç¬¦';
        } else {
            matchIndicator.classList.remove('match');
            matchIndicator.classList.add('no-match');
            matchMessage.textContent = 'âœ— å¯†ç¢¼ä¸ç›¸ç¬¦';
        }
    }

    // ç›£è½æ–°å¯†ç¢¼è¼¸å…¥
    newPassword1.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });

    // ç›£è½ç¢ºèªå¯†ç¢¼è¼¸å…¥
    newPassword2.addEventListener('input', checkPasswordMatch);

    // è¡¨å–®æäº¤é©—è­‰
    document.getElementById('password-change-form').addEventListener('submit', function(e) {
        if (newPassword1.value !== newPassword2.value) {
            e.preventDefault();
            alert('æ–°å¯†ç¢¼èˆ‡ç¢ºèªå¯†ç¢¼ä¸ç›¸ç¬¦ï¼Œè«‹é‡æ–°è¼¸å…¥');
            newPassword2.focus();
        }
    });
});
</script>
{% endblock %}
