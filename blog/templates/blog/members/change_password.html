{% extends 'blog/base.html' %}
{% load static %}

{% block title %}更改密碼{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/members/edit_profile.css' %}">
<style>
    .password-match-indicator {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 6px;
        font-size: 0.875rem;
        display: none;
    }

    .password-match-indicator.show {
        display: block;
    }

    .password-match-indicator.match {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #6ee7b7;
    }

    .password-match-indicator.no-match {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }

    .password-strength {
        margin-top: 0.5rem;
        font-size: 0.875rem;
    }

    .strength-bar {
        height: 4px;
        background-color: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 0.25rem;
    }

    .strength-bar-fill {
        height: 100%;
        transition: width 0.3s ease, background-color 0.3s ease;
        width: 0%;
    }

    .strength-weak .strength-bar-fill {
        background-color: #ef4444;
        width: 33%;
    }

    .strength-medium .strength-bar-fill {
        background-color: #f59e0b;
        width: 66%;
    }

    .strength-strong .strength-bar-fill {
        background-color: #10b981;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-profile-container">
    <div class="edit-card">
        <h1>更改密碼</h1>
        <p>為了保護您的帳號安全，請定期更新密碼</p>

        <form method="post" id="password-change-form">
            {% csrf_token %}

            <div class="form-section">
                <h2>密碼資訊</h2>

                <div class="form-group">
                    <label for="id_old_password">舊密碼</label>
                    <input type="password" name="old_password" class="form-control" id="id_old_password" required>
                    {% if form.old_password.errors %}
                        <ul class="errorlist">
                            {% for error in form.old_password.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <p class="form-help">請輸入您目前使用的密碼</p>
                </div>

                <div class="form-group">
                    <label for="id_new_password1">新密碼</label>
                    <input type="password" name="new_password1" class="form-control" id="id_new_password1" required>
                    {% if form.new_password1.errors %}
                        <ul class="errorlist">
                            {% for error in form.new_password1.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="password-strength">
                        <div class="strength-bar">
                            <div class="strength-bar-fill"></div>
                        </div>
                        <p class="form-help">密碼至少需要 8 個字元，且不能是常見密碼</p>
                    </div>
                </div>

                <div class="form-group">
                    <label for="id_new_password2">新密碼確認</label>
                    <input type="password" name="new_password2" class="form-control" id="id_new_password2" required>
                    {% if form.new_password2.errors %}
                        <ul class="errorlist">
                            {% for error in form.new_password2.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                    <div class="password-match-indicator" id="password-match-indicator">
                        <span id="match-message"></span>
                    </div>
                    <p class="form-help">請再次輸入新密碼以確認</p>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="submit-btn">更新密碼</button>
                <a href="{% url 'member_edit' %}" class="btn btn-secondary">取消</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const newPassword1 = document.getElementById('id_new_password1');
    const newPassword2 = document.getElementById('id_new_password2');
    const matchIndicator = document.getElementById('password-match-indicator');
    const matchMessage = document.getElementById('match-message');
    const submitBtn = document.getElementById('submit-btn');
    const strengthBar = document.querySelector('.password-strength');
    const strengthBarFill = document.querySelector('.strength-bar-fill');

    // 密碼強度檢測
    function checkPasswordStrength(password) {
        if (password.length === 0) {
            strengthBar.className = 'password-strength';
            return;
        }

        let strength = 0;
        if (password.length >= 8) strength++;
        if (password.length >= 12) strength++;
        if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
        if (/\d/.test(password)) strength++;
        if (/[^a-zA-Z0-9]/.test(password)) strength++;

        if (strength <= 2) {
            strengthBar.className = 'password-strength strength-weak';
        } else if (strength <= 4) {
            strengthBar.className = 'password-strength strength-medium';
        } else {
            strengthBar.className = 'password-strength strength-strong';
        }
    }

    // 檢查密碼是否匹配
    function checkPasswordMatch() {
        const password1 = newPassword1.value;
        const password2 = newPassword2.value;

        // 如果確認密碼框為空，不顯示任何提示
        if (password2.length === 0) {
            matchIndicator.classList.remove('show');
            return;
        }

        // 顯示匹配指示器
        matchIndicator.classList.add('show');

        if (password1 === password2) {
            matchIndicator.classList.remove('no-match');
            matchIndicator.classList.add('match');
            matchMessage.textContent = '✓ 密碼相符';
        } else {
            matchIndicator.classList.remove('match');
            matchIndicator.classList.add('no-match');
            matchMessage.textContent = '✗ 密碼不相符';
        }
    }

    // 監聽新密碼輸入
    newPassword1.addEventListener('input', function() {
        checkPasswordStrength(this.value);
        checkPasswordMatch();
    });

    // 監聽確認密碼輸入
    newPassword2.addEventListener('input', checkPasswordMatch);

    // 表單提交驗證
    document.getElementById('password-change-form').addEventListener('submit', function(e) {
        if (newPassword1.value !== newPassword2.value) {
            e.preventDefault();
            alert('新密碼與確認密碼不相符，請重新輸入');
            newPassword2.focus();
        }
    });
});
</script>
{% endblock %}
