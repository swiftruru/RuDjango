{% extends 'blog/base.html' %}
{% load static %}
{% load blog_extras %}

{% block title %}{{ article.title }} - RuDjango{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/articles/list.css' %}">
<link rel="stylesheet" href="{% static 'blog/css/articles/detail.css' %}">
<link rel="stylesheet" href="{% static 'blog/css/tags.css' %}">
{% endblock %}

{% block content %}
{% if messages %}
<div class="message-container">
    {% for message in messages %}
    <div
        class="message-item {% if message.tags == 'success' %}message-success{% elif message.tags == 'error' %}message-error{% endif %}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="article-detail-container">
    <!-- è¿”å›æŒ‰éˆ•èˆ‡æ›é å°èˆª -->
    <div class="top-navigation-container">
        <a href="{% url 'blog_home' %}" class="back-button">â† è¿”å›åˆ—è¡¨</a>
        <div class="pagination-nav">
            {% if previous_article %}
            <a href="{% url 'article_detail' previous_article.id %}" class="nav-button prev-button"
                title="{{ previous_article.title }}">
                â† ä¸Šä¸€ç¯‡
            </a>
            {% else %}
            <span class="nav-button nav-disabled">â† ä¸Šä¸€ç¯‡</span>
            {% endif %}
            {% if next_article %}
            <a href="{% url 'article_detail' next_article.id %}" class="nav-button next-button"
                title="{{ next_article.title }}">
                ä¸‹ä¸€ç¯‡ â†’
            </a>
            {% else %}
            <span class="nav-button nav-disabled">ä¸‹ä¸€ç¯‡ â†’</span>
            {% endif %}
        </div>
    </div>

    <!-- æ–‡ç« æ¨™é¡Œå€ -->
    <div class="article-header">
        <!-- åˆ†äº«æŒ‰éˆ• -->
        <button class="share-article-icon-btn" id="share-article-btn" title="åˆ†äº«æ–‡ç« ">
            ğŸ”—
        </button>

        <!-- ç·¨è¼¯èˆ‡åˆªé™¤æŒ‰éˆ• -->
        {% if article.author == request.user %}
        <div class="article-header-actions">
            <a href="{% url 'article_edit' article.id %}" class="action-icon-button edit-icon-button" title="ç·¨è¼¯æ–‡ç« ">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </a>
            <a href="{% url 'article_delete' article.id %}?next={{ request.path }}" class="action-icon-button delete-icon-button" title="åˆªé™¤æ–‡ç« ">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </a>
        </div>
        {% endif %}

        <h1>{{ article.title }}</h1>
        <div class="article-meta">
            {% if article.author %}
            <span>âœï¸ ä½œè€…ï¼š<a href="{% url 'member_profile' username=article.author.username %}" class="author-link">{{ article.author|author_display }}</a></span>
            {% endif %}
            <span>ğŸ“… ç™¼å¸ƒæ–¼ {{ article.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
            {% if article.created_at != article.updated_at %}
            <span>âœï¸ æ›´æ–°æ–¼ {{ article.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
            {% endif %}
        </div>
        {% if article.tags.all %}
        <div class="article-tags-detail">
            {% for tag in article.tags.all %}
            <a href="{% url 'tag_articles' tag.slug %}" class="tag-link">ğŸ·ï¸ {{ tag.name }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- æ–‡ç« å…§å®¹ -->
    <div class="article-content-wrapper"
         data-article-id="{{ article.id }}"
         data-article-url="{% url 'article_detail' article.id %}"
         data-article-title="{{ article.title }}"
         data-article-excerpt="{{ article.content|striptags|truncatewords:20 }}">
        <div class="article-content">{{ article.content|markdown }}</div>
    </div>

    <!-- é»è®šå€ (Instagram é¢¨æ ¼) -->
    <div class="article-like-section">
        {% if user.is_authenticated %}
            {% if article.author == user %}
                <button class="like-button own-article"
                        id="like-button-own">
                    <span class="like-icon">ğŸ¤</span>
                    <span class="like-text">è®š</span>
                </button>
                {% if like_count > 0 %}
                <span class="like-count-display">Â· {{ like_count }}</span>
                {% endif %}
            {% else %}
                <button class="like-button {% if user_has_liked %}liked{% endif %}"
                        id="like-button"
                        data-article-id="{{ article.id }}"
                        data-liked="{% if user_has_liked %}true{% else %}false{% endif %}">
                    <span class="like-icon">{% if user_has_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                    <span class="like-text">è®š</span>
                </button>
                {% if like_count > 0 %}
                <span class="like-count-display">Â· {{ like_count }}</span>
                {% endif %}
            {% endif %}
        {% else %}
            <a href="{% url 'user_login' %}?next={{ request.path }}" class="like-button">
                <span class="like-icon">ğŸ¤</span>
                <span class="like-text">è®š</span>
            </a>
            {% if like_count > 0 %}
            <span class="like-count-display">Â· {{ like_count }}</span>
            {% endif %}
        {% endif %}
    </div>

    <!-- æ–‡ç« åº•éƒ¨ -->
    <div class="article-footer">
        <!-- æ›é å°èˆª -->
        <div class="pagination-nav-bottom">
            {% if previous_article %}
            <a href="{% url 'article_detail' previous_article.id %}" class="nav-button prev-button"
                title="{{ previous_article.title }}">
                â† ä¸Šä¸€ç¯‡
            </a>
            {% else %}
            <span class="nav-button nav-disabled">â† ä¸Šä¸€ç¯‡</span>
            {% endif %}
            {% if next_article %}
            <a href="{% url 'article_detail' next_article.id %}" class="nav-button next-button"
                title="{{ next_article.title }}">
                ä¸‹ä¸€ç¯‡ â†’
            </a>
            {% else %}
            <span class="nav-button nav-disabled">ä¸‹ä¸€ç¯‡ â†’</span>
            {% endif %}
        </div>

        <div class="footer-actions-container">
            <a href="{% url 'blog_home' %}" class="back-button">â† è¿”å›åˆ—è¡¨</a>
        </div>
    </div>

    <!-- ç•™è¨€å€ -->
    <div class="comments-section">
        <h2 class="comments-title">ğŸ’¬ ç•™è¨€ ({{ comments.count }})</h2>

        <!-- ç™¼è¡¨ç•™è¨€è¡¨å–® -->
        {% if user.is_authenticated %}
        <div class="comment-form-container">
            <form method="post" class="comment-form">
                {% csrf_token %}
                <div class="form-group">
                    {{ comment_form.content }}
                </div>
                <button type="submit" class="submit-comment-btn">ç™¼è¡¨ç•™è¨€</button>
            </form>
        </div>
        {% else %}
        <div class="login-prompt">
            <p>è«‹å…ˆ<a href="{% url 'user_login' %}?next={{ request.path }}">ç™»å…¥</a>å¾Œå†ç™¼è¡¨ç•™è¨€</p>
        </div>
        {% endif %}

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div class="comments-list">
            {% if comments %}
            {% for comment in comments %}
            <div class="comment-item">
                <div class="comment-header">
                    <div class="comment-author">
                        <span class="author-icon">ğŸ‘¤</span>
                        <span class="author-name">{{ comment.author.first_name|default:comment.author.username }}</span>
                    </div>
                    <div class="comment-actions">
                        <span class="comment-time">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                        {% if comment.author == request.user %}
                        <a href="{% url 'comment_delete' comment.id %}?next={{ request.path }}" class="comment-delete-btn" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ')">ğŸ—‘ï¸ åˆªé™¤</a>
                        {% endif %}
                    </div>
                </div>
                <div class="comment-content">{{ comment.content|linebreaksbr }}</div>

                <!-- å›è¦†ç•™è¨€ -->
                {% if comment.replies.all %}
                <div class="replies-list">
                    {% for reply in comment.replies.all %}
                    <div class="reply-item">
                        <div class="comment-header">
                            <div class="comment-author">
                                <span class="author-icon">ğŸ‘¤</span>
                                <span class="author-name">{{ reply.author.first_name|default:reply.author.username }}</span>
                            </div>
                            <div class="comment-actions">
                                <span class="comment-time">{{ reply.created_at|date:"Y-m-d H:i" }}</span>
                                {% if reply.author == request.user %}
                                <a href="{% url 'comment_delete' reply.id %}?next={{ request.path }}" class="comment-delete-btn" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ')">ğŸ—‘ï¸ åˆªé™¤</a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="comment-content">{{ reply.content|linebreaksbr }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="no-comments">
                <p>ç›®å‰é‚„æ²’æœ‰ç•™è¨€ï¼Œå¿«ä¾†æ¶æ²™ç™¼å§ï¼</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- åˆ†äº«é¸å–® -->
    <div id="share-article-menu" class="share-menu" style="display: none;">
        <div class="share-menu-content">
            <h3>åˆ†äº«æ–‡ç« </h3>
            <div class="share-buttons">
                <button class="share-button facebook" data-platform="facebook">
                    <span class="share-icon">f</span>
                    Facebook
                </button>
                <button class="share-button twitter" data-platform="twitter">
                    <span class="share-icon">ğ•</span>
                    Twitter
                </button>
                <button class="share-button line" data-platform="line">
                    <span class="share-icon">L</span>
                    LINE
                </button>
                <button class="share-button copy-link" data-platform="copy">
                    <span class="share-icon">ğŸ”—</span>
                    è¤‡è£½é€£çµ
                </button>
            </div>
            <button class="share-close" id="share-article-close">âœ•</button>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="{% static 'blog/js/articles/share.js' %}"></script>
<script src="{% static 'blog/js/articles/like.js' %}"></script>
{% endblock %}
{% endblock %}