{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ member.name }} - æœƒå“¡ä¸­å¿ƒ{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/members/profile.css' %}">
{% endblock %}

{% block content %}
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Profile Header -->
<section class="profile-header">
    <div class="container">
        <div class="header-content">
            <div class="avatar-section">
                <div class="avatar-large">
                    <img src="{% static 'blog/images/å¤§é ­ç¶ .JPG' %}" alt="{{ member.name }}" class="avatar-img">
                </div>
                <div class="level-badge {{ member.level|lower }}">
                    {% if member.level == 'Gold' %}ğŸ¥‡{% endif %}
                    {{ member.level }}
                </div>
            </div>

            <div class="profile-info">
                <h1 class="profile-name">{{ member.name }}</h1>
                <p class="profile-username">@{{ member.username }}</p>
                <p class="profile-bio">{{ member.bio }}</p>

                <div class="profile-meta">
                    <span class="meta-item">
                        <span class="icon">ğŸ«</span>
                        {{ member.school }}
                    </span>
                    <span class="meta-item">
                        <span class="icon">ğŸ“š</span>
                        {{ member.grade }}
                    </span>
                    <span class="meta-item">
                        <span class="icon">ğŸ“</span>
                        {{ member.location }}
                    </span>
                    <span class="meta-item">
                        <span class="icon">ğŸ“…</span>
                        åŠ å…¥æ–¼ {{ member.joined_date }}
                    </span>
                </div>

                <div class="profile-actions">
                    {% if is_own_profile %}
                    <a href="{% url 'member_edit' %}" class="btn btn-primary">ç·¨è¼¯å€‹äººè³‡æ–™</a>
                    {% else %}
                    <button class="btn btn-primary">è¿½è¹¤</button>
                    <button class="btn btn-secondary">ç™¼é€è¨Šæ¯</button>
                    {% endif %}
                    <button class="btn btn-outline" id="share-btn">åˆ†äº«</button>
                </div>

                <!-- åˆ†äº«é¸å–® -->
                <div id="share-menu" class="share-menu" style="display: none;">
                    <div class="share-menu-content">
                        <h3>åˆ†äº«å€‹äººè³‡æ–™</h3>
                        <div class="share-buttons">
                            <button class="share-button facebook" data-platform="facebook">
                                <span class="share-icon">f</span>
                                Facebook
                            </button>
                            <button class="share-button twitter" data-platform="twitter">
                                <span class="share-icon">ğ•</span>
                                Twitter
                            </button>
                            <button class="share-button line" data-platform="line">
                                <span class="share-icon">L</span>
                                LINE
                            </button>
                            <button class="share-button copy-link" data-platform="copy">
                                <span class="share-icon">ğŸ”—</span>
                                è¤‡è£½é€£çµ
                            </button>
                        </div>
                        <button class="share-close" id="share-close">âœ•</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="level-progress">
            <div class="progress-info">
                <span>ç­‰ç´šé€²åº¦</span>
                <span class="progress-text">{{ member.points }} / {{ member.next_level_points }} XP</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {% widthratio member.points member.next_level_points 100 %}%;">
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Stats Grid -->
<section class="stats-section">
    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">ğŸ“</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.posts }}</div>
                    <div class="stat-label">ç™¼è¡¨æ–‡ç« </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¬</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.comments }}</div>
                    <div class="stat-label">è©•è«–æ•¸</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">â¤ï¸</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.likes_received }}</div>
                    <div class="stat-label">ç²å¾—è®šæ•¸</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.followers }}</div>
                    <div class="stat-label">è¿½è¹¤è€…</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸŒŸ</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.following }}</div>
                    <div class="stat-label">è¿½è¹¤ä¸­</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">ğŸ’¼</div>
                <div class="stat-content">
                    <div class="stat-number">{{ member.stats.projects }}</div>
                    <div class="stat-label">å°ˆæ¡ˆæ•¸</div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Main Content -->
<section class="main-content">
    <div class="container">
        <div class="content-grid">
            <!-- Left Column -->
            <div class="left-column">
                {% if is_own_profile %}
                <!-- Recent Activities (åªæœ‰æœ¬äººèƒ½çœ‹åˆ°) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æœ€è¿‘æ´»å‹•</h2>
                    </div>
                    <div class="card-body">
                        <div class="activity-list">
                            {% for activity in member.recent_activities %}
                            <div class="activity-item">
                                <div class="activity-icon">{{ activity.icon }}</div>
                                <div class="activity-content">
                                    <p class="activity-title">{{ activity.title }}</p>
                                    <span class="activity-time">{{ activity.date }}</span>
                                </div>
                            </div>
                            {% empty %}
                            <p style="color: #6b7280; font-size: 0.875rem; text-align: center;">å°šç„¡æ´»å‹•è¨˜éŒ„</p>
                            {% endfor %}
                        </div>
                        {% if member.recent_activities %}
                        <button class="btn-text">æŸ¥çœ‹æ›´å¤šæ´»å‹• â†’</button>
                        {% endif %}
                    </div>
                </div>

                <!-- Learning Progress (åªæœ‰æœ¬äººèƒ½çœ‹åˆ°) -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">å­¸ç¿’é€²åº¦</h2>
                    </div>
                    <div class="card-body">
                        {% for course in member.learning_progress %}
                        <div class="course-item">
                            <div class="course-info">
                                <span class="course-name">{{ course.course }}</span>
                                <span class="course-percent">{{ course.progress }}%</span>
                            </div>
                            <div class="course-bar">
                                <div class="course-fill"
                                    style="width: {{ course.progress }}%; background: {{ course.color }};"></div>
                            </div>
                        </div>
                        {% empty %}
                        <p style="color: #6b7280; font-size: 0.875rem; text-align: center;">å°šç„¡å­¸ç¿’é€²åº¦</p>
                        {% endfor %}
                        {% if member.learning_progress %}
                        <button class="btn-text">æŸ¥çœ‹æ‰€æœ‰èª²ç¨‹ â†’</button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- æœ€è¿‘ç™¼è¡¨çš„æ–‡ç« ï¼ˆæ‰€æœ‰äººéƒ½èƒ½çœ‹åˆ°ï¼‰ -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æœ€è¿‘ç™¼è¡¨</h2>
                    </div>
                    <div class="card-body">
                        {% if member.recent_articles %}
                        <div class="articles-list">
                            {% for article in member.recent_articles %}
                            <div class="article-item">
                                <a href="{% url 'article_detail' id=article.id %}" class="article-link">
                                    <h3 class="article-title">{{ article.title }}</h3>
                                    <p class="article-excerpt">{{ article.content|truncatewords:20 }}</p>
                                    <div class="article-meta">
                                        <span class="article-date">{{ article.created_at|date:"Y-m-d" }}</span>
                                    </div>
                                </a>
                            </div>
                            {% endfor %}
                        </div>
                        <a href="{% url 'blog_home' %}?author={{ member.username }}" class="btn-text">æŸ¥çœ‹æ‰€æœ‰æ–‡ç«  â†’</a>
                        {% else %}
                        <p style="color: #6b7280; font-size: 0.875rem; text-align: center;">å°šæœªç™¼è¡¨ä»»ä½•æ–‡ç« </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="right-column">
                <!-- Skills -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æŠ€èƒ½æ¨™ç±¤</h2>
                    </div>
                    <div class="card-body">
                        <div class="skills-grid">
                            {% for skill in member.skills %}
                            <span class="skill-tag">{{ skill }}</span>
                            {% empty %}
                            <p style="color: #6b7280; font-size: 0.875rem;">å°šæœªæ–°å¢æŠ€èƒ½æ¨™ç±¤</p>
                            {% endfor %}
                        </div>
                        {% if is_own_profile %}
                        <a href="{% url 'edit_skills' %}" class="btn-text">ç·¨è¼¯æŠ€èƒ½ â†’</a>
                        {% endif %}
                    </div>
                </div>

                <!-- Achievements -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">æˆå°±å¾½ç« </h2>
                    </div>
                    <div class="card-body">
                        <div class="achievements-grid">
                            {% for achievement in member.achievements %}
                            <div class="achievement-item">
                                <div class="achievement-icon">{{ achievement.icon }}</div>
                                <div class="achievement-info">
                                    <p class="achievement-name">{{ achievement.name }}</p>
                                    <p class="achievement-desc">{{ achievement.description }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button class="btn-text">æŸ¥çœ‹æ‰€æœ‰æˆå°± â†’</button>
                    </div>
                </div>

                <!-- Quick Info -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">å€‹äººè³‡è¨Š</h2>
                    </div>
                    <div class="card-body">
                        <div class="info-list">
                            {% if is_own_profile and member.email %}
                            <div class="info-item">
                                <span class="info-label">é›»å­ä¿¡ç®±</span>
                                <span class="info-value">{{ member.email }}</span>
                            </div>
                            {% endif %}
                            {% if is_own_profile and member.birthday %}
                            <div class="info-item">
                                <span class="info-label">ç”Ÿæ—¥</span>
                                <span class="info-value">{{ member.birthday }}</span>
                            </div>
                            {% endif %}
                            <div class="info-item">
                                <span class="info-label">ç©åˆ†</span>
                                <span class="info-value">{{ member.points }} XP</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">æœƒå“¡ç­‰ç´š</span>
                                <span class="info-value">{{ member.level }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const shareBtn = document.getElementById('share-btn');
        const shareMenu = document.getElementById('share-menu');
        const shareClose = document.getElementById('share-close');
        const shareButtons = document.querySelectorAll('.share-button');

        // ç•¶å‰é é¢çš„ URL å’Œæ¨™é¡Œ
        const currentUrl = window.location.origin + '{% url "member_profile" username=member.username %}';
        const pageTitle = '{{ member.name }} çš„å€‹äººè³‡æ–™ - RuDjango';
        const pageDescription = '{{ member.bio|default:"æŸ¥çœ‹æˆ‘çš„å€‹äººè³‡æ–™"|truncatewords:20 }}';

        // é–‹å•Ÿåˆ†äº«é¸å–®
        if (shareBtn) {
            shareBtn.addEventListener('click', function () {
                shareMenu.style.display = 'flex';
            });
        }

        // é—œé–‰åˆ†äº«é¸å–®
        function closeShareMenu() {
            shareMenu.style.display = 'none';
        }

        if (shareClose) {
            shareClose.addEventListener('click', closeShareMenu);
        }

        // é»æ“ŠèƒŒæ™¯é—œé–‰
        shareMenu.addEventListener('click', function (e) {
            if (e.target === shareMenu) {
                closeShareMenu();
            }
        });

        // ESC éµé—œé–‰
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && shareMenu.style.display === 'flex') {
                closeShareMenu();
            }
        });

        // è™•ç†åˆ†äº«æŒ‰éˆ•
        shareButtons.forEach(button => {
            button.addEventListener('click', function () {
                const platform = this.dataset.platform;

                switch (platform) {
                    case 'facebook':
                        shareFacebook();
                        break;
                    case 'twitter':
                        shareTwitter();
                        break;
                    case 'line':
                        shareLine();
                        break;
                    case 'copy':
                        copyLink();
                        break;
                }
            });
        });

        // Facebook åˆ†äº«
        function shareFacebook() {
            const fbUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(currentUrl)}`;
            window.open(fbUrl, '_blank', 'width=600,height=400');
            closeShareMenu();
        }

        // Twitter åˆ†äº«
        function shareTwitter() {
            const twitterUrl = `https://twitter.com/intent/tweet?url=${encodeURIComponent(currentUrl)}&text=${encodeURIComponent(pageTitle)}`;
            window.open(twitterUrl, '_blank', 'width=600,height=400');
            closeShareMenu();
        }

        // LINE åˆ†äº«
        function shareLine() {
            const lineUrl = `https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(currentUrl)}`;
            window.open(lineUrl, '_blank', 'width=600,height=400');
            closeShareMenu();
        }

        // è¤‡è£½é€£çµ
        function copyLink() {
            // ä½¿ç”¨ç¾ä»£çš„ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(currentUrl).then(function () {
                    showCopySuccess();
                }).catch(function (err) {
                    // é™ç´šæ–¹æ¡ˆ
                    fallbackCopyLink();
                });
            } else {
                // é™ç´šæ–¹æ¡ˆ
                fallbackCopyLink();
            }
        }

        // é™ç´šçš„è¤‡è£½æ–¹æ¡ˆ
        function fallbackCopyLink() {
            const textArea = document.createElement('textarea');
            textArea.value = currentUrl;
            textArea.style.position = 'fixed';
            textArea.style.left = '-9999px';
            document.body.appendChild(textArea);
            textArea.select();

            try {
                document.execCommand('copy');
                showCopySuccess();
            } catch (err) {
                alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ï¼š' + currentUrl);
            }

            document.body.removeChild(textArea);
        }

        // é¡¯ç¤ºè¤‡è£½æˆåŠŸæç¤º
        function showCopySuccess() {
            const copyButton = document.querySelector('.share-button.copy-link');
            const originalText = copyButton.innerHTML;

            copyButton.innerHTML = '<span class="share-icon" style="background: #10b981;">âœ“</span>å·²è¤‡è£½ï¼';
            copyButton.style.borderColor = '#10b981';
            copyButton.style.color = '#10b981';

            setTimeout(function () {
                copyButton.innerHTML = originalText;
                copyButton.style.borderColor = '';
                copyButton.style.color = '';
                closeShareMenu();
            }, 1500);
        }
    });
</script>
{% endblock %}
{% endblock %}