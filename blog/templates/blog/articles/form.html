{% extends 'blog/base.html' %}
{% load static %}

{% block title %}{{ action }} - RuDjango{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/articles/form.css' %}">
<link rel="stylesheet" href="{% static 'blog/css/articles/features.css' %}">
<link rel="stylesheet" href="{% static 'blog/css/mention-autocomplete.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="form-container">
        <div class="form-header">
            <h1>{{ action }}</h1>
            <div class="autosave-status" id="autosave-status">
                <span class="status-icon">ğŸ’¾</span>
                <span class="status-text">ä½¿ç”¨ Cmd/Ctrl + S å¿«é€Ÿå„²å­˜è‰ç¨¿</span>
            </div>
        </div>

        <!-- Gmail é¢¨æ ¼è‰ç¨¿æç¤ºï¼ˆç·¨è¼¯å·²ç™¼å¸ƒæ–‡ç« ä¸”æœ‰è‰ç¨¿æ™‚é¡¯ç¤ºï¼‰ -->
        {% if article and article.status == 'published' and article.has_draft %}
        <div class="draft-notification-bar">
            <div class="draft-notification-content">
                <div class="draft-notification-info">
                    <span class="draft-icon">ğŸ“</span>
                    <div class="draft-text">
                        <strong>æ­£åœ¨ç·¨è¼¯è‰ç¨¿ç‰ˆæœ¬</strong>
                        <span class="draft-time-text">{{ article.draft_updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }} ä¸Šæ¬¡å„²å­˜</span>
                    </div>
                </div>
                <div class="draft-notification-actions">
                    <a href="{% url 'draft_publish' article.id %}" class="btn-draft-publish-primary" onclick="return confirm('ç¢ºå®šè¦ç™¼å¸ƒè‰ç¨¿ï¼Ÿé€™å°‡è¦†è“‹ç›®å‰çš„å·²ç™¼å¸ƒå…§å®¹ã€‚')">
                        ç™¼å¸ƒè‰ç¨¿
                    </a>
                    <a href="{% url 'draft_discard' article.id %}" class="btn-draft-discard-secondary" onclick="return confirm('ç¢ºå®šè¦æ¨æ£„è‰ç¨¿ï¼Ÿè‰ç¨¿å…§å®¹å°‡æœƒè¢«åˆªé™¤ã€‚')">
                        æ¨æ£„è‰ç¨¿
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

        <form method="post" novalidate id="article-form" data-article-id="{% if article %}{{ article.id }}{% endif %}">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div class="form-errors">
                {{ form.non_field_errors }}
            </div>
            {% endif %}

            <div class="form-group">
                <label for="id_title">{{ form.title.label }}</label>
                {{ form.title }}
                {% if form.title.help_text %}
                <span class="help-text">{{ form.title.help_text }}</span>
                {% endif %}
                {{ form.title.errors }}
            </div>

            <div class="form-group">
                <label for="id_content">{{ form.content.label }}</label>
                {{ form.content }}
                {% if form.content.help_text %}
                <span class="help-text">{{ form.content.help_text }}</span>
                {% endif %}
                {{ form.content.errors }}
            </div>

            <div class="form-group">
                <label for="id_tags-input">{{ form.tags_input.label }}</label>
                {{ form.tags_input }}
                {% if form.tags_input.help_text %}
                <span class="help-text">{{ form.tags_input.help_text }}</span>
                {% endif %}
                {{ form.tags_input.errors }}
            </div>

            <!-- ç™¼å¸ƒé¸é … -->
            <div class="form-group">
                <label for="id_status">ç™¼å¸ƒç‹€æ…‹</label>
                <select name="status" id="id_status" class="form-control">
                    {% if article and article.status == 'published' %}
                    <option value="published" selected>ç«‹å³æ›´æ–°</option>
                    {% else %}
                    <option value="published" {% if not article or article.status == 'published' %}selected{% endif %}>ç«‹å³ç™¼å¸ƒ</option>
                    <option value="scheduled" {% if article and article.status == 'scheduled' %}selected{% endif %}>æ’ç¨‹ç™¼å¸ƒ</option>
                    {% endif %}
                </select>
            </div>

            <!-- æ’ç¨‹æ™‚é–“ (åƒ…åœ¨é¸æ“‡æ’ç¨‹ç™¼å¸ƒæ™‚é¡¯ç¤º) -->
            <div class="form-group" id="publish-at-group" style="display: none;">
                <label for="id_publish_at">æ’ç¨‹ç™¼å¸ƒæ™‚é–“</label>
                <input type="datetime-local" name="publish_at" id="id_publish_at" class="form-control"
                       value="{% if article and article.publish_at and article.status == 'scheduled' %}{{ article.publish_at|date:'Y-m-d\TH:i' }}{% endif %}"
                       min="">
                <span class="help-text">é¸æ“‡æ–‡ç« è‡ªå‹•ç™¼å¸ƒçš„æ™‚é–“ï¼ˆå¿…é ˆæ˜¯æœªä¾†æ™‚é–“ï¼Œé è¨­ç‚º 30 åˆ†é˜å¾Œï¼‰</span>
            </div>

            <!-- Gmail é¢¨æ ¼çš„æ“ä½œæŒ‰éˆ•å€ -->
            <div class="form-actions-container">
                <div class="form-actions-primary">
                    <button type="submit" class="btn btn-publish" name="action" value="publish">
                        {% if article and article.status == 'published' %}âœï¸ æ›´æ–°æ–‡ç« {% else %}ğŸ“¤ ç™¼å¸ƒ{% endif %}
                    </button>
                    <button type="submit" class="btn btn-save-draft" name="action" value="draft">
                        ğŸ’¾ å„²å­˜ç‚ºè‰ç¨¿
                    </button>
                </div>
                <a href="{% if article %}{% url 'article_detail' article.id %}{% else %}{% url 'blog_home' %}{% endif %}"
                    class="btn btn-cancel">å–æ¶ˆ</a>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
// æ§åˆ¶æ’ç¨‹æ™‚é–“æ¬„ä½çš„é¡¯ç¤º/éš±è—
document.addEventListener('DOMContentLoaded', function() {
    const statusSelect = document.getElementById('id_status');
    const publishAtGroup = document.getElementById('publish-at-group');
    const publishAtInput = document.getElementById('id_publish_at');

    // æ ¼å¼åŒ–æ—¥æœŸæ™‚é–“ç‚º datetime-local æ ¼å¼
    function formatDateTime(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    // è¨­å®šæœ€å°å¯é¸æ™‚é–“ç‚ºç•¶å‰æ™‚é–“
    function setMinDateTime() {
        const now = new Date();
        publishAtInput.min = formatDateTime(now);
    }

    // è¨­å®šé è¨­æ’ç¨‹æ™‚é–“ï¼ˆç•¶å‰æ™‚é–“ + 30 åˆ†é˜ï¼Œä¸¦é€²ä½åˆ°ä¸‹å€‹æ•´ 5 åˆ†é˜ï¼‰
    function setDefaultPublishTime() {
        // å¦‚æœæ¬„ä½å·²ç¶“æœ‰å€¼ï¼ˆç·¨è¼¯ç¾æœ‰æ–‡ç« ï¼‰ï¼Œå°±ä¸è¦†è“‹
        if (publishAtInput.value) {
            return;
        }

        // å–å¾—ç•¶å‰æ™‚é–“ä¸¦åŠ  30 åˆ†é˜
        const now = new Date();
        now.setMinutes(now.getMinutes() + 30);

        // é€²ä½åˆ°ä¸‹å€‹æ•´ 5 åˆ†é˜ï¼ˆä¾‹å¦‚ï¼š14:23 -> 14:25, 14:28 -> 14:30ï¼‰
        const minutes = now.getMinutes();
        const roundedMinutes = Math.ceil(minutes / 5) * 5;
        now.setMinutes(roundedMinutes);
        now.setSeconds(0);
        now.setMilliseconds(0);

        publishAtInput.value = formatDateTime(now);
    }

    function togglePublishAtField() {
        if (statusSelect.value === 'scheduled') {
            publishAtGroup.style.display = 'block';
            publishAtInput.required = true;
            setMinDateTime(); // è¨­å®šæœ€å°æ™‚é–“é™åˆ¶
            setDefaultPublishTime();
        } else {
            publishAtGroup.style.display = 'none';
            publishAtInput.required = false;
        }
    }

    // åˆå§‹åŒ–
    setMinDateTime(); // é é¢è¼‰å…¥æ™‚å°±è¨­å®šæœ€å°æ™‚é–“
    togglePublishAtField();

    // ç›£è½ç‹€æ…‹è®Šæ›´
    statusSelect.addEventListener('change', togglePublishAtField);

    // æ¯åˆ†é˜æ›´æ–°ä¸€æ¬¡æœ€å°æ™‚é–“é™åˆ¶ï¼ˆç¢ºä¿ min å€¼å§‹çµ‚æ˜¯æœ€æ–°çš„ï¼‰
    setInterval(setMinDateTime, 60000);

    // ========== è‡ªå‹•å„²å­˜è‰ç¨¿åŠŸèƒ½ ==========
    const form = document.getElementById('article-form');
    const autosaveStatus = document.getElementById('autosave-status');
    const statusIcon = autosaveStatus.querySelector('.status-icon');
    const statusText = autosaveStatus.querySelector('.status-text');
    const articleId = form.dataset.articleId;

    let isSaving = false;
    let lastSavedTime = null;

    // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
    function updateStatus(state, message) {
        if (state === 'saving') {
            statusIcon.textContent = 'â³';
            statusText.textContent = 'æ­£åœ¨å„²å­˜...';
            autosaveStatus.className = 'autosave-status saving';
        } else if (state === 'saved') {
            statusIcon.textContent = 'âœ…';
            statusText.textContent = message;
            autosaveStatus.className = 'autosave-status saved';
            lastSavedTime = new Date();
            updateTimeSince();
        } else if (state === 'error') {
            statusIcon.textContent = 'âŒ';
            statusText.textContent = message;
            autosaveStatus.className = 'autosave-status error';
        } else {
            statusIcon.textContent = 'ğŸ’¾';
            statusText.textContent = message;
            autosaveStatus.className = 'autosave-status';
        }
    }

    // æ›´æ–°ã€Œå¤šä¹…å‰å„²å­˜ã€çš„æ™‚é–“é¡¯ç¤º
    function updateTimeSince() {
        if (!lastSavedTime) return;

        const now = new Date();
        const diff = Math.floor((now - lastSavedTime) / 1000); // ç§’

        let timeText;
        if (diff < 60) {
            timeText = 'å‰›å‰›';
        } else if (diff < 3600) {
            const minutes = Math.floor(diff / 60);
            timeText = `${minutes} åˆ†é˜å‰`;
        } else {
            const hours = Math.floor(diff / 3600);
            timeText = `${hours} å°æ™‚å‰`;
        }

        statusText.textContent = `å·²å„²å­˜è‰ç¨¿ (${timeText})`;
    }

    // æ¯ 30 ç§’æ›´æ–°ä¸€æ¬¡æ™‚é–“é¡¯ç¤º
    setInterval(updateTimeSince, 30000);

    // è‡ªå‹•å„²å­˜å‡½æ•¸
    async function autosaveDraft() {
        if (isSaving) return;

        const titleField = document.getElementById('id_title');
        const contentField = document.getElementById('id_content');
        const tagsField = document.getElementById('tags-input');

        if (!titleField || !contentField) {
            console.error('Form fields not found');
            updateStatus('error', 'è¡¨å–®æ¬„ä½éŒ¯èª¤');
            return;
        }

        const title = titleField.value;
        const content = contentField.value;
        const tagsInput = tagsField ? tagsField.value : '';

        // å¦‚æœæ¨™é¡Œå’Œå…§å®¹éƒ½æ˜¯ç©ºçš„ï¼Œä¸ä¿å­˜
        if (!title.trim() && !content.trim()) {
            updateStatus('default', 'ä½¿ç”¨ Cmd/Ctrl + S å¿«é€Ÿå„²å­˜è‰ç¨¿');
            return;
        }

        isSaving = true;
        updateStatus('saving', 'æ­£åœ¨å„²å­˜...');

        try {
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            const url = articleId
                ? `/blog/article/${articleId}/autosave/`
                : '/blog/article/autosave/';

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({
                    title: title,
                    content: content,
                    tags_input: tagsInput,
                })
            });

            const data = await response.json();

            if (data.success) {
                updateStatus('saved', 'å·²å„²å­˜è‰ç¨¿ (å‰›å‰›)');

                // å¦‚æœæ˜¯æ–°æ–‡ç« ï¼Œæ›´æ–°è¡¨å–®çš„ article ID å’Œ URL
                if (!articleId && data.article_id) {
                    form.dataset.articleId = data.article_id;
                    // æ›´æ–°ç€è¦½å™¨æ­·å²è¨˜éŒ„ï¼Œä½†ä¸é‡æ–°è¼‰å…¥é é¢
                    const newUrl = `/blog/article/${data.article_id}/edit/`;
                    history.replaceState({}, '', newUrl);
                }
            } else {
                updateStatus('error', data.error || 'å„²å­˜å¤±æ•—');
            }
        } catch (error) {
            console.error('Autosave error:', error);
            updateStatus('error', 'å„²å­˜å¤±æ•—ï¼šç¶²è·¯éŒ¯èª¤');
        } finally {
            isSaving = false;
        }
    }

    // ç›£è½ Cmd/Ctrl + S å¿«æ·éµ
    document.addEventListener('keydown', function(e) {
        // Cmd + S (Mac) æˆ– Ctrl + S (Windows/Linux)
        if ((e.metaKey || e.ctrlKey) && e.key === 's') {
            e.preventDefault(); // é˜²æ­¢ç€è¦½å™¨çš„é è¨­å„²å­˜è¡Œç‚º
            autosaveDraft();
        }
    });
});
</script>

<script src="{% static 'blog/js/mention-autocomplete.js' %}"></script>
{% endblock %}
{% endblock %}