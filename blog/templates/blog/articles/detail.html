{% extends 'blog/base.html' %}
{% load static %}
{% load blog_extras %}

{% block title %}{{ article.title }} - RuDjango{% endblock %}

{# SEO Meta Tags #}
{% block meta_description %}{{ meta_description }}{% endblock %}
{% block meta_keywords %}{{ meta_keywords }}{% endblock %}
{% block meta_author %}{{ article.author.first_name|default:article.author.username }}{% endblock %}

{# Open Graph Tags #}
{% block og_title %}{{ article.title }}{% endblock %}
{% block og_description %}{{ meta_description }}{% endblock %}
{% block og_type %}article{% endblock %}
{% block og_url %}{{ request.build_absolute_uri }}{% endblock %}
{% if og_image_url %}
{% block og_image %}<meta property="og:image" content="{{ og_image_url }}">{% endblock %}
{% endif %}

{# Twitter Card Tags #}
{% block twitter_title %}{{ article.title }}{% endblock %}
{% block twitter_description %}{{ meta_description }}{% endblock %}
{% if og_image_url %}
{% block twitter_image %}<meta name="twitter:image" content="{{ og_image_url }}">{% endblock %}
{% endif %}

{# Canonical URL #}
{% block canonical_url %}{{ request.build_absolute_uri }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'blog/css/articles/list.css' %}?v={{ article.updated_at|date:'U' }}">
<link rel="stylesheet" href="{% static 'blog/css/articles/detail.css' %}?v={{ article.updated_at|date:'U' }}">
<link rel="stylesheet" href="{% static 'blog/css/articles/features.css' %}?v={{ article.updated_at|date:'U' }}">
<link rel="stylesheet" href="{% static 'blog/css/tags.css' %}?v={{ article.updated_at|date:'U' }}">
<link rel="stylesheet" href="{% static 'blog/css/mention-autocomplete.css' %}">
<!-- Highlight.js èªæ³•é«˜äº®ä¸»é¡Œ (GitHub Dark) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<!-- KaTeX æ•¸å­¸å…¬å¼æ¨£å¼ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
<style>
/* Mermaid åœ–è¡¨æ¨£å¼ */
.article-content .mermaid-container {
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1.5rem 0;
    overflow-x: auto;
    text-align: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.article-content .mermaid-container svg {
    max-width: 100%;
    height: auto;
}

/* KaTeX æ•¸å­¸å…¬å¼æ¨£å¼ */
.article-content .katex {
    font-size: 1.1em;
}

.article-content .katex-display {
    margin: 1.5rem 0;
    overflow-x: auto;
    overflow-y: hidden;
}
</style>
{% endblock %}

{% block content %}
<div class="article-detail-container">
    <!-- è¿”å›æŒ‰éˆ•èˆ‡æ›é å°èˆª -->
    <div class="top-navigation-container">
        <a href="{% url 'blog_home' %}" class="back-button">â† è¿”å›åˆ—è¡¨</a>
        <div class="pagination-nav">
            {% if previous_article %}
            <a href="{% url 'article_detail' previous_article.id %}" class="nav-button prev-button"
                title="{{ previous_article.title }}">
                â† ä¸Šä¸€ç¯‡
            </a>
            {% else %}
            <span class="nav-button nav-disabled">â† ä¸Šä¸€ç¯‡</span>
            {% endif %}
            {% if next_article %}
            <a href="{% url 'article_detail' next_article.id %}" class="nav-button next-button"
                title="{{ next_article.title }}">
                ä¸‹ä¸€ç¯‡ â†’
            </a>
            {% else %}
            <span class="nav-button nav-disabled">ä¸‹ä¸€ç¯‡ â†’</span>
            {% endif %}
        </div>
    </div>

    <!-- è‰ç¨¿é€šçŸ¥å€ï¼ˆé ‚éƒ¨ç¨ç«‹é¡¯ç¤ºï¼Œé»æ“Šå¯å‰å¾€ç·¨è¼¯ï¼‰ -->
    {% if article.author == request.user and article.status == 'published' and article.has_draft %}
    <a href="{% url 'article_edit' article.id %}" class="draft-notification-bar draft-notification-link">
        <div class="draft-notification-content">
            <div class="draft-notification-info">
                <span class="draft-icon">ğŸ“</span>
                <div class="draft-text">
                    <strong>æœ‰æœªç™¼å¸ƒçš„è‰ç¨¿ä¿®æ”¹</strong>
                    <span class="draft-time-text">{{ article.draft_updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }} æ›´æ–°</span>
                </div>
            </div>
            <div class="draft-notification-action">
                <span class="draft-edit-hint">é»æ“ŠæŸ¥çœ‹ä¸¦ç·¨è¼¯è‰ç¨¿ â†’</span>
            </div>
        </div>
    </a>
    {% endif %}

    <!-- æ–‡ç« æ¨™é¡Œå€ -->
    <div class="article-header">
        <!-- åˆ†äº«æŒ‰éˆ• -->
        <button class="share-article-icon-btn" id="share-article-btn" title="åˆ†äº«æ–‡ç« ">
            ğŸ”—
        </button>

        <!-- ç·¨è¼¯èˆ‡åˆªé™¤æŒ‰éˆ• -->
        {% if article.author == request.user %}
        <div class="article-header-actions">
            <a href="{% url 'article_edit' article.id %}" class="action-icon-button edit-icon-button" title="ç·¨è¼¯æ–‡ç« ">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
            </a>
            <a href="{% url 'article_delete' article.id %}?next={{ request.path }}" class="action-icon-button delete-icon-button" title="åˆªé™¤æ–‡ç« ">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    <line x1="10" y1="11" x2="10" y2="17"></line>
                    <line x1="14" y1="11" x2="14" y2="17"></line>
                </svg>
            </a>
        </div>
        {% endif %}

        <h1>{{ article.title }}</h1>

        <!-- ç‹€æ…‹æ¨™ç±¤ (åƒ…ä½œè€…å¯è¦‹) -->
        {% if article.author == request.user %}
            {% if article.status == 'draft' %}
                <div class="article-status-badge draft">
                    <span>ğŸ“ è‰ç¨¿</span>
                </div>
            {% elif article.status == 'scheduled' %}
                {% load tz %}
                {% now "U" as current_timestamp %}
                {% if article.publish_at|date:"U" > current_timestamp %}
                    <div class="article-status-badge scheduled">
                        <span>â° æ’ç¨‹ç™¼å¸ƒæ–¼ {{ article.publish_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
                    </div>
                {% endif %}
            {% endif %}
        {% endif %}

        <div class="article-meta">
            {% if article.author %}
            <span>âœï¸ ä½œè€…ï¼š<a href="{% url 'member_profile' username=article.author.username %}" class="author-link">{{ article.author|author_display }}</a></span>
            {% endif %}
            <span>ğŸ“… ç™¼å¸ƒæ–¼ {% if article.status == 'scheduled' and article.publish_at and article.publish_at|date:"U" > current_timestamp %}{{ article.publish_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}{% else %}{{ article.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}{% endif %}</span>
            {% if article.created_at != article.updated_at %}
            <span>âœï¸ æ›´æ–°æ–¼ {{ article.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</span>
            {% endif %}
            {% if article.reading_time > 0 %}
            <span>ğŸ“– é–±è®€æ™‚é–“: {{ article.reading_time }} åˆ†é˜</span>
            {% endif %}
        </div>
        {% if article.tags.all %}
        <div class="article-tags-detail">
            {% for tag in article.tags.all %}
            <a href="{% url 'tag_articles' tag.slug %}" class="tag-link">ğŸ·ï¸ {{ tag.name }}</a>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- ç›®éŒ„ -->
    {% if table_of_contents %}
    <div class="table-of-contents">
        <div class="toc-header">
            <h3>ğŸ“‘ ç›®éŒ„</h3>
            <button class="toc-toggle" id="toc-toggle">
                <span class="toc-toggle-icon">â–¼</span>
            </button>
        </div>
        <nav class="toc-nav" id="toc-nav">
            <ul class="toc-list">
            {% for item in table_of_contents %}
                <li class="toc-item toc-level-{{ item.level }}">
                    <a href="#{{ item.anchor }}" class="toc-link">{{ item.title }}</a>
                </li>
            {% endfor %}
            </ul>
        </nav>
    </div>
    {% endif %}

    <!-- æ–‡ç« å…§å®¹ -->
    <div class="article-content-wrapper"
         data-article-id="{{ article.id }}"
         data-article-url="{% url 'article_detail' article.id %}"
         data-article-title="{{ article.title }}"
         data-article-excerpt="{{ article.content|striptags|truncatewords:20 }}">
        <div class="article-content" id="article-content"></div>
    </div>

    <!-- å°‡ Markdown å…§å®¹ä»¥ JSON æ ¼å¼å„²å­˜ -->
    <script id="article-markdown-data" type="application/json">{{ article.content|safe }}</script>

    <!-- é»è®šèˆ‡æ”¶è—å€ -->
    <div class="article-actions-section">
        <div class="article-like-section">
            {% if user.is_authenticated %}
                {% if article.author == user %}
                    <button class="like-button own-article"
                            id="like-button-own">
                        <span class="like-icon">ğŸ¤</span>
                        <span class="like-text">è®š</span>
                    </button>
                    {% if like_count > 0 %}
                    <span class="like-count-display">Â· {{ like_count }}</span>
                    {% endif %}
                {% else %}
                    <button class="like-button {% if user_has_liked %}liked{% endif %}"
                            id="like-button"
                            data-article-id="{{ article.id }}"
                            data-liked="{% if user_has_liked %}true{% else %}false{% endif %}">
                        <span class="like-icon">{% if user_has_liked %}â¤ï¸{% else %}ğŸ¤{% endif %}</span>
                        <span class="like-text">è®š</span>
                    </button>
                    {% if like_count > 0 %}
                    <span class="like-count-display">Â· {{ like_count }}</span>
                    {% endif %}
                {% endif %}
            {% else %}
                <a href="{% url 'user_login' %}?next={{ request.path }}" class="like-button">
                    <span class="like-icon">ğŸ¤</span>
                    <span class="like-text">è®š</span>
                </a>
                {% if like_count > 0 %}
                <span class="like-count-display">Â· {{ like_count }}</span>
                {% endif %}
            {% endif %}
        </div>

        <!-- æ”¶è—æŒ‰éˆ• -->
        <div class="article-bookmark-section">
            {% if user.is_authenticated %}
                <button class="bookmark-button {% if user_has_bookmarked %}bookmarked{% endif %}"
                        id="bookmark-button"
                        data-article-id="{{ article.id }}"
                        data-bookmarked="{% if user_has_bookmarked %}true{% else %}false{% endif %}">
                    <span class="bookmark-icon">{% if user_has_bookmarked %}ğŸ”–{% else %}ğŸ“‘{% endif %}</span>
                    <span class="bookmark-text">æ”¶è—</span>
                </button>
                {% if bookmark_count > 0 %}
                <span class="bookmark-count-display" id="bookmark-count">Â· {{ bookmark_count }}</span>
                {% endif %}
            {% else %}
                <a href="{% url 'user_login' %}?next={{ request.path }}" class="bookmark-button">
                    <span class="bookmark-icon">ğŸ“‘</span>
                    <span class="bookmark-text">æ”¶è—</span>
                </a>
                {% if bookmark_count > 0 %}
                <span class="bookmark-count-display">Â· {{ bookmark_count }}</span>
                {% endif %}
            {% endif %}
        </div>

        <!-- åˆ†äº«çµ±è¨ˆ -->
        {% if share_count > 0 %}
        <div class="article-share-stats">
            <span class="share-count">ğŸ”— {{ share_count }} æ¬¡åˆ†äº«</span>
        </div>
        {% endif %}
    </div>

    <!-- æ–‡ç« åº•éƒ¨ -->
    <div class="article-footer">
        <!-- æ›é å°èˆª -->
        <div class="pagination-nav-bottom">
            {% if previous_article %}
            <a href="{% url 'article_detail' previous_article.id %}" class="nav-button prev-button"
                title="{{ previous_article.title }}">
                â† ä¸Šä¸€ç¯‡
            </a>
            {% else %}
            <span class="nav-button nav-disabled">â† ä¸Šä¸€ç¯‡</span>
            {% endif %}
            {% if next_article %}
            <a href="{% url 'article_detail' next_article.id %}" class="nav-button next-button"
                title="{{ next_article.title }}">
                ä¸‹ä¸€ç¯‡ â†’
            </a>
            {% else %}
            <span class="nav-button nav-disabled">ä¸‹ä¸€ç¯‡ â†’</span>
            {% endif %}
        </div>

        <div class="footer-actions-container">
            <a href="{% url 'blog_home' %}" class="back-button">â† è¿”å›åˆ—è¡¨</a>
        </div>
    </div>

    <!-- ç•™è¨€å€ -->
    <div class="comments-section">
        <h2 class="comments-title">ğŸ’¬ ç•™è¨€ ({{ comments.count }})</h2>

        <!-- ç™¼è¡¨ç•™è¨€è¡¨å–® -->
        {% if user.is_authenticated %}
        <div class="comment-form-container">
            <form method="post" class="comment-form">
                {% csrf_token %}
                <div class="form-group">
                    <textarea name="content" id="comment-content" class="form-control" rows="4" placeholder="è¼¸å…¥ @ å¯ä»¥æåŠå…¶ä»–ä½¿ç”¨è€…..." data-mention-autocomplete data-search-url="{% url 'search_users_for_mention' %}"></textarea>
                </div>
                <button type="submit" class="submit-comment-btn">ç™¼è¡¨ç•™è¨€</button>
            </form>
        </div>
        {% else %}
        <div class="login-prompt">
            <p>è«‹å…ˆ<a href="{% url 'user_login' %}?next={{ request.path }}">ç™»å…¥</a>å¾Œå†ç™¼è¡¨ç•™è¨€</p>
        </div>
        {% endif %}

        <!-- ç•™è¨€åˆ—è¡¨ -->
        <div class="comments-list">
            {% if comments %}
            {% for comment in comments %}
            <div class="comment-item" id="comment-{{ comment.id }}">
                <div class="comment-header">
                    <div class="comment-author">
                        <span class="author-icon">ğŸ‘¤</span>
                        <span class="author-name">{{ comment.author.first_name|default:comment.author.username }}</span>
                    </div>
                    <div class="comment-actions">
                        <span class="comment-time">{{ comment.created_at|date:"Y-m-d H:i" }}</span>
                        {% if comment.author == request.user %}
                        <a href="{% url 'comment_delete' comment.id %}?next={{ request.path }}" class="comment-delete-btn" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ')">ğŸ—‘ï¸ åˆªé™¤</a>
                        {% endif %}
                    </div>
                </div>
                <div class="comment-content">{{ comment.content|linebreaksbr|highlight_mentions|safe }}</div>

                <!-- å›è¦†ç•™è¨€ -->
                {% if comment.replies.all %}
                <div class="replies-list">
                    {% for reply in comment.replies.all %}
                    <div class="reply-item" id="comment-{{ reply.id }}">
                        <div class="comment-header">
                            <div class="comment-author">
                                <span class="author-icon">ğŸ‘¤</span>
                                <span class="author-name">{{ reply.author.first_name|default:reply.author.username }}</span>
                            </div>
                            <div class="comment-actions">
                                <span class="comment-time">{{ reply.created_at|date:"Y-m-d H:i" }}</span>
                                {% if reply.author == request.user %}
                                <a href="{% url 'comment_delete' reply.id %}?next={{ request.path }}" class="comment-delete-btn" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡ç•™è¨€å—ï¼Ÿ')">ğŸ—‘ï¸ åˆªé™¤</a>
                                {% endif %}
                            </div>
                        </div>
                        <div class="comment-content">{{ reply.content|linebreaksbr|highlight_mentions|safe }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% else %}
            <div class="no-comments">
                <p>ç›®å‰é‚„æ²’æœ‰ç•™è¨€ï¼Œå¿«ä¾†æ¶æ²™ç™¼å§ï¼</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- åˆ†äº«é¸å–® -->
    <div id="share-article-menu" class="share-menu" style="display: none;">
        <div class="share-menu-content">
            <h3>åˆ†äº«æ–‡ç« </h3>
            <div class="share-buttons">
                <button class="share-button facebook" data-platform="facebook">
                    <span class="share-icon">f</span>
                    Facebook
                </button>
                <button class="share-button twitter" data-platform="twitter">
                    <span class="share-icon">ğ•</span>
                    Twitter
                </button>
                <button class="share-button line" data-platform="line">
                    <span class="share-icon">L</span>
                    LINE
                </button>
                <button class="share-button copy-link" data-platform="copy">
                    <span class="share-icon">ğŸ”—</span>
                    è¤‡è£½é€£çµ
                </button>
            </div>
            <button class="share-close" id="share-article-close">âœ•</button>
        </div>
    </div>

    <!-- Back to Top æŒ‰éˆ• -->
    <button class="back-to-top" id="back-to-top" title="å›åˆ°é ‚ç«¯">
        â†‘
    </button>
</div>

{% block extra_js %}
<!-- Marked.js - Markdown è§£æå™¨ -->
<script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
<!-- Highlight.js èªæ³•é«˜äº® -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<!-- KaTeX æ•¸å­¸å…¬å¼ -->
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
<!-- Mermaid åœ–è¡¨ -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
    // ä½¿ç”¨å®¢æˆ¶ç«¯æ¸²æŸ“ Markdownï¼ˆè·Ÿç·¨è¼¯é è¦½ä¸€æ¨£çš„æ–¹å¼ï¼‰
    document.addEventListener('DOMContentLoaded', async function() {
        const articleContent = document.getElementById('article-content');
        const markdownDataScript = document.getElementById('article-markdown-data');

        if (!articleContent || !markdownDataScript) {
            console.error('Article content element or markdown data not found');
            return;
        }

        // å¾ script æ¨™ç±¤å–å¾—åŸå§‹ Markdown å…§å®¹
        const markdownContent = markdownDataScript.textContent;

        if (!markdownContent || !markdownContent.trim()) {
            console.error('No markdown content found');
            return;
        }

        // æ­¥é©Ÿ 1: ä½¿ç”¨ marked.js è§£æ Markdown
        const html = marked.parse(markdownContent);
        articleContent.innerHTML = html;

        // æ­¥é©Ÿ 2: è™•ç† @mention é€£çµ
        const mentionRegex = /@([a-zA-Z0-9_]+)/g;
        articleContent.innerHTML = articleContent.innerHTML.replace(mentionRegex, function(match, username) {
            return `<a href="/blog/member/${username}/" class="mention" title="${match}">@${username}</a>`;
        });

        // æ­¥é©Ÿ 3: åˆå§‹åŒ– Mermaid
        if (window.mermaid) {
            mermaid.initialize({
                startOnLoad: false,
                theme: 'default',
                securityLevel: 'loose'
            });

            // æ¸²æŸ“ Mermaid åœ–è¡¨
            const mermaidBlocks = articleContent.querySelectorAll('pre code.language-mermaid');
            for (let i = 0; i < mermaidBlocks.length; i++) {
                const block = mermaidBlocks[i];
                const code = block.textContent;
                const id = `mermaid-detail-${i}`;

                try {
                    const { svg } = await mermaid.render(id, code);
                    const container = document.createElement('div');
                    container.className = 'mermaid-container';
                    container.innerHTML = svg;
                    block.parentElement.replaceWith(container);
                } catch (err) {
                    console.error('Mermaid render error:', err);
                }
            }
        }

        // æ­¥é©Ÿ 4: åˆå§‹åŒ–èªæ³•é«˜äº®ï¼ˆæ’é™¤ Mermaid å€å¡Šï¼‰
        if (window.hljs) {
            articleContent.querySelectorAll('pre code:not(.language-mermaid)').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        // æ­¥é©Ÿ 5: æ¸²æŸ“æ•¸å­¸å…¬å¼
        if (window.renderMathInElement) {
            try {
                renderMathInElement(articleContent, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\[', right: '\\]', display: true},
                        {left: '\\(', right: '\\)', display: false}
                    ],
                    throwOnError: false,
                    trust: true
                });
                console.log('KaTeX rendering completed');
            } catch (err) {
                console.error('KaTeX render error:', err);
            }
        } else {
            console.warn('KaTeX renderMathInElement not found');
        }
    });
</script>
<script src="{% static 'blog/js/articles/share.js' %}?v={{ article.updated_at|date:'U' }}"></script>
<script src="{% static 'blog/js/articles/like.js' %}?v={{ article.updated_at|date:'U' }}"></script>
<script src="{% static 'blog/js/articles/bookmark.js' %}?v={{ article.updated_at|date:'U' }}"></script>
<script src="{% static 'blog/js/articles/toc.js' %}?v={{ article.updated_at|date:'U' }}"></script>
<script src="{% static 'blog/js/mention-autocomplete.js' %}"></script>

<script>
// Back to Top åŠŸèƒ½
(function() {
    const backToTopButton = document.getElementById('back-to-top');

    if (!backToTopButton) return;

    // æ»¾å‹•æ™‚é¡¯ç¤º/éš±è—æŒ‰éˆ•
    let scrollTimeout;
    window.addEventListener('scroll', function() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(function() {
            if (window.pageYOffset > 300) {
                backToTopButton.classList.add('show');
            } else {
                backToTopButton.classList.remove('show');
            }
        }, 100);
    });

    // é»æ“ŠæŒ‰éˆ•å›åˆ°é ‚ç«¯
    backToTopButton.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });
})();
</script>
{% endblock %}
{% endblock %}